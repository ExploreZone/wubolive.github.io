<!-- build time:Tue Dec 25 2018 09:56:22 GMT+0800 (中国标准时间) --><!DOCTYPE html><html lang="zh"><head><meta name="generator" content="Hexo 3.8.0"><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,minimum-scale=1,user-scalable=no,minimal-ui"><meta name="renderer" content="webkit"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="black"><meta name="format-detection" content="telephone=no,email=no,adress=no"><meta name="theme-color" content="#000000"><meta http-equiv="window-target" content="_top"><title>源码安装Kubernetes1.13 | Wave Blog</title><meta name="description" content="环境说明：角色IP组件k8s-master172.17.0.81kube-apiserver,kube-controller-manage,kube-scheduler,etcdk8s-node1172.17.0.82kubelet,kube-proxy,docker,flannel,etcdk8s-node2172.17.0.83kubelet,kube-proxy,docker,flannel"><meta name="keywords" content="K8s,Docker"><meta property="og:type" content="article"><meta property="og:title" content="源码安装Kubernetes1.13"><meta property="og:url" content="http://blog.wubolive.com/2018/12/25/kubernetes1.13/index.html"><meta property="og:site_name" content="Hexo"><meta property="og:description" content="环境说明：角色IP组件k8s-master172.17.0.81kube-apiserver,kube-controller-manage,kube-scheduler,etcdk8s-node1172.17.0.82kubelet,kube-proxy,docker,flannel,etcdk8s-node2172.17.0.83kubelet,kube-proxy,docker,flannel"><meta property="og:locale" content="zh-CN"><meta property="og:updated_time" content="2018-12-25T01:55:54.455Z"><meta name="twitter:card" content="summary"><meta name="twitter:title" content="源码安装Kubernetes1.13"><meta name="twitter:description" content="环境说明：角色IP组件k8s-master172.17.0.81kube-apiserver,kube-controller-manage,kube-scheduler,etcdk8s-node1172.17.0.82kubelet,kube-proxy,docker,flannel,etcdk8s-node2172.17.0.83kubelet,kube-proxy,docker,flannel"><link rel="canonical" href="http://blog.wubolive.com/2018/12/25/kubernetes1.13/index.html"><link rel="alternate" href="/atom.xml" title="Hexo" type="application/atom+xml"><link rel="icon" href="/favicon.png" type="image/x-icon"><link rel="stylesheet" href="/css/style.css"><link rel="stylesheet" href="//cdn.jsdelivr.net/npm/gitalk@1.4.0/dist/gitalk.min.css"></head><body class="main-center" itemscope itemtype="http://schema.org/WebPage"><header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="slimContent"><div class="navbar-header"><div class="profile-block text-center"><a id="avatar" href="https://github.com/wubolive" target="_blank"><img class="img-circle img-rotate" src="/images/avatar.jpg" width="200" height="200"></a><h2 id="name" class="hidden-xs hidden-sm">Wave</h2><h3 id="title" class="hidden-xs hidden-sm hidden-md">Linux operation</h3><small id="location" class="text-muted hidden-xs hidden-sm"><i class="icon icon-map-marker"></i> BeiJing, China</small></div><div class="search" id="search-form-wrap"><form class="search-form sidebar-form"><div class="input-group"><input type="text" class="search-form-input form-control" placeholder="搜索"> <span class="input-group-btn"><button type="submit" class="search-form-submit btn btn-flat" onclick="return!1"><i class="icon icon-search"></i></button></span></div></form><div class="ins-search"><div class="ins-search-mask"></div><div class="ins-search-container"><div class="ins-input-wrapper"><input type="text" class="ins-search-input" placeholder="想要查找什么..." x-webkit-speech=""> <button type="button" class="close ins-close ins-selectable" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">×</span></button></div><div class="ins-section-wrapper"><div class="ins-section-container"></div></div></div></div></div><button class="navbar-toggle collapsed" type="button" data-toggle="collapse" data-target="#main-navbar" aria-controls="main-navbar" aria-expanded="false"><span class="sr-only">Toggle navigation</span> <span class="icon-bar"></span> <span class="icon-bar"></span> <span class="icon-bar"></span></button></div><nav id="main-navbar" class="collapse navbar-collapse" itemscope itemtype="http://schema.org/SiteNavigationElement" role="navigation"><ul class="nav navbar-nav main-nav"><li class="menu-item menu-item-home"><a href="/."><i class="icon icon-home-fill"></i> <span class="menu-title">首页</span></a></li><li class="menu-item menu-item-archives"><a href="/archives"><i class="icon icon-archives-fill"></i> <span class="menu-title">归档</span></a></li><li class="menu-item menu-item-categories"><a href="/categories"><i class="icon icon-folder"></i> <span class="menu-title">分类</span></a></li><li class="menu-item menu-item-tags"><a href="/tags"><i class="icon icon-tags"></i> <span class="menu-title">标签</span></a></li><li class="menu-item menu-item-repository"><a href="/repository"><i class="icon icon-project"></i> <span class="menu-title">项目</span></a></li><li class="menu-item menu-item-links"><a href="/links"><i class="icon icon-friendship"></i> <span class="menu-title">友链</span></a></li><li class="menu-item menu-item-about"><a href="/about"><i class="icon icon-cup-fill"></i> <span class="menu-title">关于</span></a></li></ul><ul class="social-links"><li><a href="https://github.com/wubolive" target="_blank" title="Github" data-toggle="tooltip" data-placement="top"><i class="icon icon-github"></i></a></li><li><a href="http://weibo.com/cofess" target="_blank" title="Weibo" data-toggle="tooltip" data-placement="top"><i class="icon icon-weibo"></i></a></li><li><a href="https://twitter.com/iwebued" target="_blank" title="Twitter" data-toggle="tooltip" data-placement="top"><i class="icon icon-twitter"></i></a></li><li><a href="https://www.behance.net/cofess" target="_blank" title="Behance" data-toggle="tooltip" data-placement="top"><i class="icon icon-behance"></i></a></li><li><a href="/atom.xml" target="_blank" title="Rss" data-toggle="tooltip" data-placement="top"><i class="icon icon-rss"></i></a></li></ul></nav></div></header><aside class="sidebar" itemscope itemtype="http://schema.org/WPSideBar"><div class="slimContent"><div class="widget"><h3 class="widget-title">公告</h3><div class="widget-body"><div id="board"><div class="content"><p>欢迎交流与分享经验!</p></div></div></div></div><div class="widget"><h3 class="widget-title">分类</h3><div class="widget-body"><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/Ansable/">Ansable</a><span class="category-list-count">3</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/K8s/">K8s</a><span class="category-list-count">4</span><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/K8s/Docker/">Docker</a><span class="category-list-count">3</span></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/Kvm/">Kvm</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Linux/">Linux</a><span class="category-list-count">4</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/MQ/">MQ</a><span class="category-list-count">1</span></li></ul></div></div><div class="widget"><h3 class="widget-title">标签</h3><div class="widget-body"><ul class="tag-list"><li class="tag-list-item"><a class="tag-list-link" href="/tags/Ansible/">Ansible</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Docker/">Docker</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/FTP/">FTP</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/K8s/">K8s</a><span class="tag-list-count">4</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Kvm/">Kvm</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Linux/">Linux</a><span class="tag-list-count">8</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/NFS/">NFS</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Vnc/">Vnc</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/rabbitMQ/">rabbitMQ</a><span class="tag-list-count">1</span></li></ul></div></div><div class="widget"><h3 class="widget-title">标签云</h3><div class="widget-body tagcloud"><a href="/tags/Ansible/" style="font-size:13.5px">Ansible</a> <a href="/tags/Docker/" style="font-size:13.5px">Docker</a> <a href="/tags/FTP/" style="font-size:13px">FTP</a> <a href="/tags/K8s/" style="font-size:13.75px">K8s</a> <a href="/tags/Kvm/" style="font-size:13px">Kvm</a> <a href="/tags/Linux/" style="font-size:14px">Linux</a> <a href="/tags/NFS/" style="font-size:13px">NFS</a> <a href="/tags/Vnc/" style="font-size:13.25px">Vnc</a> <a href="/tags/rabbitMQ/" style="font-size:13px">rabbitMQ</a></div></div><div class="widget"><h3 class="widget-title">归档</h3><div class="widget-body"><ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/12/">十二月 2018</a><span class="archive-list-count">9</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/11/">十一月 2018</a><span class="archive-list-count">4</span></li></ul></div></div><div class="widget"><h3 class="widget-title">最新文章</h3><div class="widget-body"><ul class="recent-post-list list-unstyled no-thumbnail"><li><div class="item-inner"><p class="item-category"><a class="category-link" href="/categories/K8s/">K8s</a><i class="icon icon-angle-right"></i><a class="category-link" href="/categories/K8s/Docker/">Docker</a></p><p class="item-title"><a href="/2018/12/25/kubernetes1.13/" class="title">源码安装Kubernetes1.13</a></p><p class="item-date"><time datetime="2018-12-25T01:17:28.000Z" itemprop="datePublished">2018-12-25</time></p></div></li><li><div class="item-inner"><p class="item-category"><a class="category-link" href="/categories/K8s/">K8s</a></p><p class="item-title"><a href="/2018/12/18/k8s-pod-error/" class="title">Kubernetes 排错之 Pod 异常</a></p><p class="item-date"><time datetime="2018-12-18T11:26:22.000Z" itemprop="datePublished">2018-12-18</time></p></div></li><li><div class="item-inner"><p class="item-category"><a class="category-link" href="/categories/Linux/">Linux</a></p><p class="item-title"><a href="/2018/12/07/nfs-install/" class="title">CentOS6 安装nfs共享目录服务</a></p><p class="item-date"><time datetime="2018-12-07T09:13:28.000Z" itemprop="datePublished">2018-12-07</time></p></div></li><li><div class="item-inner"><p class="item-category"><a class="category-link" href="/categories/Linux/">Linux</a></p><p class="item-title"><a href="/2018/12/07/vnc-pord/" class="title">vncserver端口占用解决方法</a></p><p class="item-date"><time datetime="2018-12-07T09:00:28.000Z" itemprop="datePublished">2018-12-07</time></p></div></li><li><div class="item-inner"><p class="item-category"><a class="category-link" href="/categories/MQ/">MQ</a></p><p class="item-title"><a href="/2018/12/07/rebbitmq-install/" class="title">rabbitMQ 安装</a></p><p class="item-date"><time datetime="2018-12-07T07:00:28.000Z" itemprop="datePublished">2018-12-07</time></p></div></li></ul></div></div></div></aside><aside class="sidebar sidebar-toc collapse" id="collapseToc" itemscope itemtype="http://schema.org/WPSideBar"><div class="slimContent"><nav id="toc" class="article-toc"><h3 class="toc-title">文章目录</h3><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#环境说明："><span class="toc-number">1.</span> <span class="toc-text">环境说明：</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#环境准备"><span class="toc-number">2.</span> <span class="toc-text">环境准备</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#系统配置"><span class="toc-number">2.1.</span> <span class="toc-text">系统配置</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#升级并优化内核"><span class="toc-number">2.2.</span> <span class="toc-text">升级并优化内核</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Node节点安装Docker"><span class="toc-number">2.3.</span> <span class="toc-text">Node节点安装Docker</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#部署Etcd集群"><span class="toc-number">3.</span> <span class="toc-text">部署Etcd集群</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#创建Etcd认证证书"><span class="toc-number">3.1.</span> <span class="toc-text">创建Etcd认证证书</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#生成Etcd-CA证书和私钥"><span class="toc-number">3.2.</span> <span class="toc-text">生成Etcd CA证书和私钥</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#安装Etcd"><span class="toc-number">3.3.</span> <span class="toc-text">安装Etcd</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#启动Etcd集群"><span class="toc-number">3.4.</span> <span class="toc-text">启动Etcd集群</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#部署Flannel网络"><span class="toc-number">4.</span> <span class="toc-text">部署Flannel网络</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#向Etcd写入集群Pod网段信息"><span class="toc-number">4.1.</span> <span class="toc-text">向Etcd写入集群Pod网段信息</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#安装及配置Flanneld"><span class="toc-number">4.2.</span> <span class="toc-text">安装及配置Flanneld</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#验证Flanneld是否生效"><span class="toc-number">4.3.</span> <span class="toc-text">验证Flanneld是否生效</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#部署Master节点"><span class="toc-number">5.</span> <span class="toc-text">部署Master节点</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Master组件简介"><span class="toc-number">5.1.</span> <span class="toc-text">Master组件简介</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#生成kubernetes证书"><span class="toc-number">5.2.</span> <span class="toc-text">生成kubernetes证书</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#部署-kube-apiserver-组件"><span class="toc-number">5.3.</span> <span class="toc-text">部署 kube-apiserver 组件</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#部署kube-scheduler"><span class="toc-number">5.4.</span> <span class="toc-text">部署kube-scheduler</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#部署kube-controller-manager"><span class="toc-number">5.5.</span> <span class="toc-text">部署kube-controller-manager</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#查看master集群状态"><span class="toc-number">5.6.</span> <span class="toc-text">查看master集群状态</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#部署Node-节点"><span class="toc-number">6.</span> <span class="toc-text">部署Node 节点</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Node组件简介"><span class="toc-number">6.1.</span> <span class="toc-text">Node组件简介</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#部署kubelet组件"><span class="toc-number">6.2.</span> <span class="toc-text">部署kubelet组件</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#approve-kubelet-CSR-请求"><span class="toc-number">6.3.</span> <span class="toc-text">approve kubelet CSR 请求</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#部署-kube-proxy-组件"><span class="toc-number">6.4.</span> <span class="toc-text">部署 kube-proxy 组件</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#查看集群状态"><span class="toc-number">6.5.</span> <span class="toc-text">查看集群状态</span></a></li></ol></li></ol></nav></div></aside><main class="main" role="main"><div class="content"><article id="post-kubernetes1.13" class="article article-type-post" itemscope itemtype="http://schema.org/BlogPosting"><div class="article-header"><h1 class="article-title" itemprop="name">源码安装Kubernetes1.13</h1><div class="article-meta"><span class="article-date"><i class="icon icon-calendar-check"></i> <a href="/2018/12/25/kubernetes1.13/" class="article-date"><time datetime="2018-12-25T01:17:28.000Z" itemprop="datePublished">2018-12-25</time></a></span> <span class="article-category"><i class="icon icon-folder"></i> <a class="article-category-link" href="/categories/K8s/">K8s</a>►<a class="article-category-link" href="/categories/K8s/Docker/">Docker</a></span> <span class="article-tag"><i class="icon icon-tags"></i> <a class="article-tag-link" href="/tags/Docker/">Docker</a>, <a class="article-tag-link" href="/tags/K8s/">K8s</a></span> <span class="article-read hidden-xs"><i class="icon icon-eye-fill" aria-hidden="true"></i> <span id="busuanzi_container_page_pv"><span id="busuanzi_value_page_pv">0</span></span></span> <span class="post-comment"><i class="icon icon-comment"></i> <a href="/2018/12/25/kubernetes1.13/#comments" class="article-comment-link">评论</a></span> <span class="post-wordcount hidden-xs" itemprop="wordCount">字数统计: 5.4k(字)</span> <span class="post-readcount hidden-xs" itemprop="timeRequired">阅读时长: 29(分)</span></div></div><div class="article-entry marked-body" itemprop="articleBody"><h2 id="环境说明："><a href="#环境说明：" class="headerlink" title="环境说明："></a>环境说明：</h2><table><thead><tr><th>角色</th><th>IP</th><th>组件</th></tr></thead><tbody><tr><td>k8s-master</td><td>172.17.0.81</td><td>kube-apiserver,kube-controller-manage,kube-scheduler,etcd</td></tr><tr><td>k8s-node1</td><td>172.17.0.82</td><td>kubelet,kube-proxy,docker,flannel,etcd</td></tr><tr><td>k8s-node2</td><td>172.17.0.83</td><td>kubelet,kube-proxy,docker,flannel,etcd</td></tr></tbody></table><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-master ~]<span class="comment"># cat /etc/redhat-release </span></span><br><span class="line">CentOS Linux release 7.6.1810 (Core)</span><br><span class="line"></span><br><span class="line">[root@k8s-master ~]<span class="comment"># uname -a</span></span><br><span class="line">Linux k8s-master 4.19.11-1.el7.elrepo.x86_64 <span class="comment">#1 SMP Wed Dec 19 14:24:42 EST 2018 x86_64 x86_64 x86_64 GNU/Linux</span></span><br></pre></td></tr></table></figure><h2 id="环境准备"><a href="#环境准备" class="headerlink" title="环境准备"></a>环境准备</h2><h3 id="系统配置"><a href="#系统配置" class="headerlink" title="系统配置"></a>系统配置</h3><p>配置hostname并添加至hosts</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-master ~]<span class="comment"># hostnamectl set-hostname [k8s-master|k8s-node1|k8s-node2]</span></span><br><span class="line"></span><br><span class="line">[root@k8s-master ~]<span class="comment"># cat &gt;&gt; /etc/hosts &lt;&lt; EOF</span></span><br><span class="line">172.17.0.81 k8s-master</span><br><span class="line">172.17.0.82 k8s-node1</span><br><span class="line">172.17.0.83 k8s-node2</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line"><span class="comment"># 配置免密</span></span><br><span class="line">[root@k8s-master ~]<span class="comment"># ssh-keygen -t rsa</span></span><br><span class="line">[root@k8s-master ~]<span class="comment"># ssh-copy-id k8s-node1</span></span><br><span class="line">[root@k8s-master ~]<span class="comment"># ssh-copy-id k8s-node2</span></span><br></pre></td></tr></table></figure><p>配置时间同步</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-master ~]<span class="comment"># yum -y install ntp</span></span><br><span class="line">[root@k8s-master ~]<span class="comment"># systemctl enable ntpd</span></span><br><span class="line">[root@k8s-master ~]<span class="comment"># systemctl start ntpd</span></span><br><span class="line">[root@k8s-master ~]<span class="comment"># ntpdate -u cn.pool.ntp.org</span></span><br><span class="line">[root@k8s-master ~]<span class="comment"># hwclock --systohc</span></span><br><span class="line">[root@k8s-master ~]<span class="comment"># timedatectl set-timezone Asia/Shangha</span></span><br></pre></td></tr></table></figure><p>关闭swap分区</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-master ~]<span class="comment"># swapoff -a &amp;&amp; sysctl -w vm.swappiness=0</span></span><br><span class="line">[root@k8s-master ~]<span class="comment"># vim /etc/fstab</span></span><br><span class="line"><span class="comment">#UUID=7bff6243-324c-4587-b550-55dc34018ebf swap		swap    defaults</span></span><br></pre></td></tr></table></figure><p>关闭防火墙及Slinux</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-master ~]# systemctl stop firewalld &amp;&amp; systemctl disable firewalld</span><br><span class="line">[root@k8s-master ~]# setenforce 0</span><br><span class="line">[root@k8s-master ~]# vim /etc/selinux/config</span><br><span class="line">[root@k8s-master ~]# SELINUX=disabled</span><br></pre></td></tr></table></figure><p>配置yum源</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-master ~]<span class="comment"># curl -o /etc/yum.repos.d/CentOS-Base.repo</span></span><br><span class="line">[root@k8s-master ~]<span class="comment"># http://mirrors.aliyun.com/repo/Centos-7.repo</span></span><br><span class="line">[root@k8s-master ~]<span class="comment"># wget -O /etc/yum.repos.d/epel.repo http://mirrors.aliyun.com/repo/epel-7.repo</span></span><br><span class="line">[root@k8s-master ~]<span class="comment"># yum makecache</span></span><br><span class="line">[root@k8s-master ~]<span class="comment"># yum install wget vim lsof net-tools lrzsz -y</span></span><br></pre></td></tr></table></figure><h3 id="升级并优化内核"><a href="#升级并优化内核" class="headerlink" title="升级并优化内核"></a>升级并优化内核</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-master ~]<span class="comment"># yum update </span></span><br><span class="line">[root@k8s-master ~]<span class="comment"># rpm --import https://www.elrepo.org/RPM-GPG-KEY-elrepo.org</span></span><br><span class="line">[root@k8s-master ~]<span class="comment"># rpm -Uvh http://www.elrepo.org/elrepo-release-7.0-2.el7.elrepo.noarch.rpm</span></span><br><span class="line">[root@k8s-master ~]<span class="comment"># yum --enablerepo=elrepo-kernel install kernel-ml -y&amp;&amp;</span></span><br><span class="line">[root@k8s-master ~]<span class="comment"># sed -i s/saved/0/g /etc/default/grub&amp;&amp;</span></span><br><span class="line">[root@k8s-master ~]<span class="comment"># grub2-mkconfig -o /boot/grub2/grub.cfg &amp;&amp; reboot</span></span><br></pre></td></tr></table></figure><p>优化内核参数</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-master ~]<span class="comment"># cat &gt;&gt; /etc/security/limits.conf &lt;&lt; EOF</span></span><br><span class="line">- soft    nofile          1024000</span><br><span class="line">- hard    nofile          1024000</span><br><span class="line">- soft    noroc           1024000</span><br><span class="line">- hard    nproc           1024000</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">[root@k8s-master ~]<span class="comment"># cat &gt;&gt; /etc/sysctl.conf &lt;&lt; EOF</span></span><br><span class="line">net.ipv4.tcp_tw_recycle = 0</span><br><span class="line">net.ipv4.ip_local_port_range = 10000 61000</span><br><span class="line">net.ipv4.tcp_syncookies = 1</span><br><span class="line">net.ipv4.tcp_fin_timeout = 30</span><br><span class="line">net.ipv4.ip_forward = 1</span><br><span class="line">net.core.netdev_max_backlog = 2000</span><br><span class="line">net.ipv4.tcp_mem = 131072  262144  524288</span><br><span class="line">net.ipv4.tcp_keepalive_intvl = 30</span><br><span class="line">net.ipv4.tcp_keepalive_probes = 3</span><br><span class="line">net.ipv4.tcp_window_scaling = 1</span><br><span class="line">net.ipv4.tcp_syncookies = 1</span><br><span class="line">net.ipv4.tcp_max_syn_backlog = 2048</span><br><span class="line">net.ipv4.tcp_low_latency = 0</span><br><span class="line">net.core.rmem_default = 256960</span><br><span class="line">net.core.rmem_max = 513920</span><br><span class="line">net.core.wmem_default = 256960</span><br><span class="line">net.core.wmem_max = 513920</span><br><span class="line">net.core.somaxconn = 2048</span><br><span class="line">net.core.optmem_max = 81920</span><br><span class="line">net.ipv4.tcp_mem = 131072  262144  524288</span><br><span class="line">net.ipv4.tcp_rmem = 8760  256960  4088000</span><br><span class="line">net.ipv4.tcp_wmem = 8760  256960  4088000</span><br><span class="line">net.ipv4.tcp_keepalive_time = 1800</span><br><span class="line">net.ipv4.tcp_sack = 1</span><br><span class="line">net.ipv4.tcp_fack = 1</span><br><span class="line">net.ipv4.tcp_timestamps = 1</span><br><span class="line">net.ipv4.tcp_syn_retries = 1</span><br><span class="line">net.bridge.bridge-nf-call-ip6tables = 1</span><br><span class="line">net.bridge.bridge-nf-call-iptables = 1</span><br><span class="line">net.bridge.bridge-nf-call-arptables = 1</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">[root@k8s-master ~]<span class="comment"># sysctl -p</span></span><br></pre></td></tr></table></figure><p>以上配置及优化内容需要在集群三台中都要配置</p><h3 id="Node节点安装Docker"><a href="#Node节点安装Docker" class="headerlink" title="Node节点安装Docker"></a>Node节点安装Docker</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 从国内源下载并安装docker-ce</span></span><br><span class="line">[root@k8s-node1 ~]<span class="comment"># yum install -y yum-utils device-mapper-persistent-data lvm2</span></span><br><span class="line">[root@k8s-node1 ~]<span class="comment"># yum-config-manager --add-repo https://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo</span></span><br><span class="line">[root@k8s-node1 ~]<span class="comment"># yum install docker-ce -y</span></span><br><span class="line"><span class="comment"># 配置docker国内镜像源并启动</span></span><br><span class="line">[root@k8s-node1 ~]<span class="comment"># curl -sSL https://get.daocloud.io/daotools/set_mirror.sh | sh -s http://bc437cce.m.daocloud.io</span></span><br><span class="line">[root@k8s-node1 ~]<span class="comment"># systemctl start docker</span></span><br><span class="line">[root@k8s-node1 ~]<span class="comment"># systemctl enable docker</span></span><br></pre></td></tr></table></figure><h2 id="部署Etcd集群"><a href="#部署Etcd集群" class="headerlink" title="部署Etcd集群"></a>部署Etcd集群</h2><p>创建安装目录</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 三台主机都可先创建好</span></span><br><span class="line">[root@k8s-master ~]<span class="comment"># mkdir /home/etcd/&#123;bin,cfg,ssl&#125; -p</span></span><br><span class="line">[root@k8s-master ~]<span class="comment"># mkdir /home/kubernetes/&#123;bin,cfg,ssl&#125; -p</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 配置环境变量</span></span><br><span class="line">[root@k8s-master ~]<span class="comment"># tail /etc/profile</span></span><br><span class="line">K8S_HOME=/home/kubernetes</span><br><span class="line">ETCD_HOME=/home/etcd</span><br><span class="line"><span class="built_in">export</span> PATH=<span class="variable">$PATH</span>:<span class="variable">$K8S_HOME</span>/bin:<span class="variable">$ETCD_HOME</span>/bin</span><br><span class="line">[root@k8s-master ~]<span class="comment"># source /etc/profile</span></span><br></pre></td></tr></table></figure><p>安装及配置CFSSL</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-master ~]<span class="comment"># wget https://pkg.cfssl.org/R1.2/cfssl_linux-amd64</span></span><br><span class="line">[root@k8s-master ~]<span class="comment"># wget https://pkg.cfssl.org/R1.2/cfssljson_linux-amd64</span></span><br><span class="line">[root@k8s-master ~]<span class="comment"># wget https://pkg.cfssl.org/R1.2/cfssl-certinfo_linux-amd64</span></span><br><span class="line">[root@k8s-master ~]<span class="comment"># chmod +x cfssl_linux-amd64 cfssljson_linux-amd64 cfssl-certinfo_linux-amd64</span></span><br><span class="line">[root@k8s-master ~]<span class="comment"># mv cfssl_linux-amd64 /usr/local/bin/cfssl</span></span><br><span class="line">[root@k8s-master ~]<span class="comment"># mv cfssljson_linux-amd64 /usr/local/bin/cfssljson</span></span><br><span class="line">[root@k8s-master ~]<span class="comment"># mv cfssl-certinfo_linux-amd64 /usr/bin/cfssl-certinfo</span></span><br></pre></td></tr></table></figure><h3 id="创建Etcd认证证书"><a href="#创建Etcd认证证书" class="headerlink" title="创建Etcd认证证书"></a>创建Etcd认证证书</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-master ~]<span class="comment"># mkdir /root/etcd_ssl &amp;&amp; cd /root/etcd_ssl</span></span><br><span class="line"><span class="comment">#创建Etcd CA配置文件</span></span><br><span class="line">[root@k8s-master ~]<span class="comment"># cat &lt;&lt; EOF | tee ca-config.json</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">"signing"</span>: &#123;</span><br><span class="line">    <span class="string">"default"</span>: &#123;</span><br><span class="line">      <span class="string">"expiry"</span>: <span class="string">"87600h"</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">"profiles"</span>: &#123;</span><br><span class="line">      <span class="string">"www"</span>: &#123;</span><br><span class="line">         <span class="string">"expiry"</span>: <span class="string">"87600h"</span>,</span><br><span class="line">         <span class="string">"usages"</span>: [</span><br><span class="line">            <span class="string">"signing"</span>,</span><br><span class="line">            <span class="string">"key encipherment"</span>,</span><br><span class="line">            <span class="string">"server auth"</span>,</span><br><span class="line">            <span class="string">"client auth"</span></span><br><span class="line">        ]</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line"><span class="comment">#创建Etcd CA 配置文件</span></span><br><span class="line">[root@k8s-master ~]<span class="comment"># cat &lt;&lt; EOF | tee ca-csr.json</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="string">"CN"</span>: <span class="string">"etcd CA"</span>,</span><br><span class="line">    <span class="string">"key"</span>: &#123;</span><br><span class="line">        <span class="string">"algo"</span>: <span class="string">"rsa"</span>,</span><br><span class="line">        <span class="string">"size"</span>: 2048</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">"names"</span>: [</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="string">"C"</span>: <span class="string">"CN"</span>,</span><br><span class="line">            <span class="string">"L"</span>: <span class="string">"Shenzhen"</span>,</span><br><span class="line">            <span class="string">"ST"</span>: <span class="string">"Shenzhen"</span></span><br><span class="line">        &#125;</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line"><span class="comment">#创建Etcd Server证书</span></span><br><span class="line">[root@k8s-master ~]<span class="comment"># cat &lt;&lt; EOF | tee server-csr.json</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="string">"CN"</span>: <span class="string">"etcd"</span>,</span><br><span class="line">    <span class="string">"hosts"</span>: [</span><br><span class="line">    <span class="string">"172.17.0.81"</span>,</span><br><span class="line">    <span class="string">"172.17.0.82"</span>,</span><br><span class="line">    <span class="string">"172.17.0.83"</span></span><br><span class="line">    ],</span><br><span class="line">    <span class="string">"key"</span>: &#123;</span><br><span class="line">        <span class="string">"algo"</span>: <span class="string">"rsa"</span>,</span><br><span class="line">        <span class="string">"size"</span>: 2048</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">"names"</span>: [</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="string">"C"</span>: <span class="string">"CN"</span>,</span><br><span class="line">            <span class="string">"L"</span>: <span class="string">"Shenzhen"</span>,</span><br><span class="line">            <span class="string">"ST"</span>: <span class="string">"Shenzhen"</span></span><br><span class="line">        &#125;</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><h3 id="生成Etcd-CA证书和私钥"><a href="#生成Etcd-CA证书和私钥" class="headerlink" title="生成Etcd CA证书和私钥"></a>生成Etcd CA证书和私钥</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-master ~]<span class="comment"># cfssl gencert -initca ca-csr.json | cfssljson -bare ca -</span></span><br><span class="line">[root@k8s-master ~]<span class="comment"># cfssl gencert -ca=ca.pem -ca-key=ca-key.pem -config=ca-config.json -profile=www server-csr.json | cfssljson -bare server</span></span><br></pre></td></tr></table></figure><p>将生成的证书文件复制到配置文件ssl目录</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-master ~]<span class="comment"># cp *.pem /home/etcd/ssl/</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 将证书复制到node节点</span></span><br><span class="line">[root@k8s-master ~]<span class="comment"># scp *.pem k8s-node1:/home/etcd/ssl/</span></span><br><span class="line">[root@k8s-master ~]<span class="comment"># scp *.pem k8s-node2:/home/etcd/ssl/</span></span><br></pre></td></tr></table></figure><h3 id="安装Etcd"><a href="#安装Etcd" class="headerlink" title="安装Etcd"></a>安装Etcd</h3><p>二进制包下载地址：<a href="https://github.com/etcd-io/etcd/releases/" target="_blank" rel="noopener">https://github.com/etcd-io/etcd/releases/</a></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-master ~]<span class="comment"># wget https://github.com/etcd-io/etcd/releases/download/v3.3.10/etcd-v3.3.10-linux-amd64.tar.gz</span></span><br><span class="line">[root@k8s-master ~]<span class="comment"># tar zxf etcd-v3.3.10-linux-amd64.tar.gz </span></span><br><span class="line">[root@k8s-master ~]<span class="comment"># cd etcd-v3.3.10-linux-amd64</span></span><br><span class="line">[root@k8s-master etcd-v3.3.10-linux-amd64]<span class="comment"># cp etcd etcdctl /home/etcd/bin/</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 将启动文件复制到node节点</span></span><br><span class="line">[root@k8s-master etcd-v3.3.10-linux-amd64]<span class="comment"># scp etcd etcdctl k8s-node1:/home/etcd/bin/</span></span><br><span class="line">[root@k8s-master etcd-v3.3.10-linux-amd64]<span class="comment"># scp etcd etcdctl k8s-node2:/home/etcd/bin/</span></span><br></pre></td></tr></table></figure><p>创建Etcd主配置文件</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-master ~]<span class="comment"># vim /home/etcd/cfg/etcd</span></span><br><span class="line"><span class="comment">#[Member]</span></span><br><span class="line">ETCD_NAME=<span class="string">"etcd01"</span></span><br><span class="line">ETCD_DATA_DIR=<span class="string">"/var/lib/etcd/default.etcd"</span></span><br><span class="line">ETCD_LISTEN_PEER_URLS=<span class="string">"https://172.17.0.81:2380"</span></span><br><span class="line">ETCD_LISTEN_CLIENT_URLS=<span class="string">"https://172.17.0.81:2379"</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#[Clustering]</span></span><br><span class="line">ETCD_INITIAL_ADVERTISE_PEER_URLS=<span class="string">"https://172.17.0.81:2380"</span></span><br><span class="line">ETCD_ADVERTISE_CLIENT_URLS=<span class="string">"https://172.17.0.81:2379"</span></span><br><span class="line">ETCD_INITIAL_CLUSTER=<span class="string">"etcd01=https://172.17.0.81:2380,etcd02=https://172.17.0.82:2380,etcd03=https://172.17.0.83:2380"</span></span><br><span class="line">ETCD_INITIAL_CLUSTER_TOKEN=<span class="string">"etcd-cluster"</span></span><br><span class="line">ETCD_INITIAL_CLUSTER_STATE=<span class="string">"new"</span></span><br></pre></td></tr></table></figure><p>创建Etcd的systemd unit 文件</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-master ~]<span class="comment"># vim /usr/lib/systemd/system/etcd.service</span></span><br><span class="line">[Unit]</span><br><span class="line">Description=Etcd Server</span><br><span class="line">After=network.target</span><br><span class="line">After=network-online.target</span><br><span class="line">Wants=network-online.target</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">Type=notify</span><br><span class="line">EnvironmentFile=/home/etcd/cfg/etcd</span><br><span class="line">ExecStart=/home/etcd/bin/etcd \</span><br><span class="line">--name=<span class="variable">$&#123;ETCD_NAME&#125;</span> \</span><br><span class="line">--data-dir=<span class="variable">$&#123;ETCD_DATA_DIR&#125;</span> \</span><br><span class="line">--listen-peer-urls=<span class="variable">$&#123;ETCD_LISTEN_PEER_URLS&#125;</span> \</span><br><span class="line">--listen-client-urls=<span class="variable">$&#123;ETCD_LISTEN_CLIENT_URLS&#125;</span>,http://127.0.0.1:2379 \</span><br><span class="line">--advertise-client-urls=<span class="variable">$&#123;ETCD_ADVERTISE_CLIENT_URLS&#125;</span> \</span><br><span class="line">--initial-advertise-peer-urls=<span class="variable">$&#123;ETCD_INITIAL_ADVERTISE_PEER_URLS&#125;</span> \</span><br><span class="line">--initial-cluster=<span class="variable">$&#123;ETCD_INITIAL_CLUSTER&#125;</span> \</span><br><span class="line">--initial-cluster-token=<span class="variable">$&#123;ETCD_INITIAL_CLUSTER_TOKEN&#125;</span> \</span><br><span class="line">--initial-cluster-state=new \</span><br><span class="line">--cert-file=/home/etcd/ssl/server.pem \</span><br><span class="line">--key-file=/home/etcd/ssl/server-key.pem \</span><br><span class="line">--peer-cert-file=/home/etcd/ssl/server.pem \</span><br><span class="line">--peer-key-file=/home/etcd/ssl/server-key.pem \</span><br><span class="line">--trusted-ca-file=/home/etcd/ssl/ca.pem \</span><br><span class="line">--peer-trusted-ca-file=/home/etcd/ssl/ca.pem</span><br><span class="line">Restart=on-failure</span><br><span class="line">LimitNOFILE=65536</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br></pre></td></tr></table></figure><p>将配置文件发送到node节点</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 复制etcd配置文件到node节点</span></span><br><span class="line">[root@k8s-master ~]<span class="comment"># scp /home/etcd/cfg/etcd k8s-node1:/home/etcd/cfg/</span></span><br><span class="line">[root@k8s-master ~]<span class="comment"># scp /home/etcd/cfg/etcd k8s-node2:/home/etcd/cfg/</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 复制systemd unit文件至node节点</span></span><br><span class="line">[root@k8s-master ~]<span class="comment"># scp /usr/lib/systemd/system/etcd.service  k8s-node1:/usr/lib/systemd/system/</span></span><br><span class="line">[root@k8s-master ~]<span class="comment"># scp /usr/lib/systemd/system/etcd.service  k8s-node2:/usr/lib/systemd/system/</span></span><br></pre></td></tr></table></figure><h3 id="启动Etcd集群"><a href="#启动Etcd集群" class="headerlink" title="启动Etcd集群"></a>启动Etcd集群</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-master ~]<span class="comment"># systemctl daemon-reload</span></span><br><span class="line">[root@k8s-master ~]<span class="comment"># systemctl start etcd</span></span><br><span class="line">[root@k8s-master ~]<span class="comment"># systemctl enable etcd</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 注：以上步骤在规划的2个node节点操作是一样的，除了etcd配置文件中的服务器IP和ETCD_NAME</span></span><br></pre></td></tr></table></figure><p>验证Etcd集群</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">etcdctl --ca-file=/home/etcd/ssl/ca.pem \</span><br><span class="line">--cert-file=/home/etcd/ssl/server.pem \</span><br><span class="line">--key-file=/home/etcd/ssl/server-key.pem \</span><br><span class="line">--endpoints=<span class="string">"https://172.17.0.81:2379,\</span></span><br><span class="line"><span class="string">https://172.17.0.82:2379,\</span></span><br><span class="line"><span class="string">https://172.17.0.83:2379"</span> cluster-health</span><br><span class="line"></span><br><span class="line"><span class="comment"># 输出以下结果说明创建成功</span></span><br><span class="line">member 2a795d9614d1f9de is healthy: got healthy result from https://172.17.0.82:2379</span><br><span class="line">member baca0e6b543a685b is healthy: got healthy result from https://172.17.0.83:2379</span><br><span class="line">member e7084551225d95f5 is healthy: got healthy result from https://172.17.0.81:2379</span><br><span class="line">cluster is healthy</span><br></pre></td></tr></table></figure><h2 id="部署Flannel网络"><a href="#部署Flannel网络" class="headerlink" title="部署Flannel网络"></a>部署Flannel网络</h2><h3 id="向Etcd写入集群Pod网段信息"><a href="#向Etcd写入集群Pod网段信息" class="headerlink" title="向Etcd写入集群Pod网段信息"></a>向Etcd写入集群Pod网段信息</h3><p>该步骤只需在第一次部署Flannel 网络时执行，后续在其他节点上部署Flanneld 时无需再写入该信息</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-master ~]<span class="comment"># etcdctl --ca-file=/home/etcd/ssl/ca.pem \</span></span><br><span class="line">--cert-file=/home/etcd/ssl/server.pem \</span><br><span class="line">--key-file=/home/etcd/ssl/server-key.pem \</span><br><span class="line">--endpoints=<span class="string">"https://172.17.0.81:2379,\</span></span><br><span class="line"><span class="string">https://172.17.0.82:2379,https://172.17.0.83:2379"</span> \</span><br><span class="line"><span class="built_in">set</span> /coreos.com/network/config  <span class="string">'&#123; "Network": "172.18.0.0/16", "Backend": &#123;"Type": "vxlan"&#125;&#125;'</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 输出如下信息说明创建成功</span></span><br><span class="line">&#123; <span class="string">"Network"</span>: <span class="string">"172.18.0.0/16"</span>, <span class="string">"Backend"</span>: &#123;<span class="string">"Type"</span>: <span class="string">"vxlan"</span>&#125;&#125;</span><br></pre></td></tr></table></figure><ul><li>flanneld 当前版本 (v0.10.0) 不支持 etcd v3，故使用 etcd v2 API 写入配置 key 和网段数据；</li><li>写入的 Pod 网段 ${CLUSTER_CIDR} 必须是 /16 段地址，必须与 kube-controller-manager 的 –cluster-cidr 参数值一致；</li></ul><h3 id="安装及配置Flanneld"><a href="#安装及配置Flanneld" class="headerlink" title="安装及配置Flanneld"></a>安装及配置Flanneld</h3><p>以下步骤在node节点中执行</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 下载二进制包</span></span><br><span class="line">[root@k8s-node1 ~]<span class="comment"># wget https://github.com/coreos/flannel/releases/download/v0.10.0/flannel-v0.10.0-linux-amd64.tar.gz</span></span><br><span class="line">[root@k8s-node1 ~]<span class="comment"># tar zxf flannel-v0.10.0-linux-amd64.tar.gz </span></span><br><span class="line">[root@k8s-node1 ~]<span class="comment"># mv flanneld mk-docker-opts.sh /home/kubernetes/bin/</span></span><br></pre></td></tr></table></figure><p>配置Flanneld</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-node1 ~]<span class="comment"># cat &gt; /home/kubernetes/cfg/flanneld &lt;&lt; EOF</span></span><br><span class="line">FLANNEL_OPTIONS=<span class="string">"--etcd-endpoints=https://172.17.0.81:2379,https://172.17.0.82:2379,https://172.17.0.83:2379 -etcd-cafile=/home/etcd/ssl/ca.pem -etcd-certfile=/home/etcd/ssl/server.pem -etcd-keyfile=/home/etcd/ssl/server-key.pem"</span></span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><p>创建flanneld的systemd unit文件</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-node1 ~]<span class="comment"># cat &gt; /usr/lib/systemd/system/flanneld.service &lt;&lt; EOF</span></span><br><span class="line">[Unit]</span><br><span class="line">Description=Flanneld overlay address etcd agent</span><br><span class="line">After=network-online.target network.target</span><br><span class="line">Before=docker.service</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">Type=notify</span><br><span class="line">EnvironmentFile=/home/kubernetes/cfg/flanneld</span><br><span class="line">ExecStart=/home/kubernetes/bin/flanneld --ip-masq <span class="variable">$FLANNEL_OPTIONS</span></span><br><span class="line">ExecStartPost=/home/kubernetes/bin/mk-docker-opts.sh -k DOCKER_NETWORK_OPTIONS -d /run/flannel/subnet.env</span><br><span class="line">Restart=on-failure</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><ul><li>mk-docker-opts.sh 脚本将分配给 flanneld 的 Pod 子网网段信息写入 /run/flannel/docker 文件，后续 docker 启动时 使用这个文件中的环境变量配置 docker0 网桥；</li><li>flanneld 使用系统缺省路由所在的接口与其它节点通信，对于有多个网络接口（如内网和公网）的节点，可以用 -iface 参数指定通信接口，如上面的 eth0 接口;</li><li>flanneld 运行时需要 root 权限；</li></ul><p>配置Docker启动指定子网段</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-node1 ~]<span class="comment"># cat &gt; /usr/lib/systemd/system/docker.service &lt;&lt; EOF</span></span><br><span class="line">[Unit]</span><br><span class="line">Description=Docker Application Container Engine</span><br><span class="line">Documentation=https://docs.docker.com</span><br><span class="line">BindsTo=containerd.service</span><br><span class="line">After=network-online.target firewalld.service</span><br><span class="line">Wants=network-online.target</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">Type=notify</span><br><span class="line">EnvironmentFile=/run/flannel/subnet.env</span><br><span class="line">ExecStart=/usr/bin/dockerd <span class="variable">$DOCKER_NETWORK_OPTIONS</span></span><br><span class="line">ExecReload=/bin/<span class="built_in">kill</span> -s HUP <span class="variable">$MAINPID</span></span><br><span class="line">TimeoutSec=0</span><br><span class="line">RestartSec=2</span><br><span class="line">Restart=always</span><br><span class="line">StartLimitBurst=3</span><br><span class="line">StartLimitInterval=60s</span><br><span class="line">LimitNOFILE=infinity</span><br><span class="line">LimitNPROC=infinity</span><br><span class="line">LimitCORE=infinity</span><br><span class="line">TasksMax=infinity</span><br><span class="line">Delegate=yes</span><br><span class="line">KillMode=process</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><p>将启动文件及配置文件复制到node2上</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-node1 ~]<span class="comment"># scp /home/kubernetes/cfg/flanneld k8s-node2:/home/kubernetes/cfg/</span></span><br><span class="line">[root@k8s-node1 ~]<span class="comment"># scp /home/kubernetes/bin/&#123;flanneld,mk-docker-opts.sh&#125; k8s-node2:/home/kubernetes/bin/</span></span><br><span class="line">[root@k8s-node1 ~]<span class="comment"># scp /usr/lib/systemd/system/flanneld.service  k8s-node2:/usr/lib/systemd/system/flanneld.service</span></span><br><span class="line">[root@k8s-node1 ~]<span class="comment"># scp /usr/lib/systemd/system/docker.service  k8s-node2:/usr/lib/systemd/system/docker.service</span></span><br></pre></td></tr></table></figure><p>启动flanneld并重启docker</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-node1 ~]# systemctl daemon-reload</span><br><span class="line">[root@k8s-node1 ~]# systemctl start flanneld</span><br><span class="line">[root@k8s-node1 ~]# systemctl enable flanneld</span><br><span class="line">[root@k8s-node1 ~]# systemctl restart docker</span><br></pre></td></tr></table></figure><h3 id="验证Flanneld是否生效"><a href="#验证Flanneld是否生效" class="headerlink" title="验证Flanneld是否生效"></a>验证Flanneld是否生效</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-node1 ~]<span class="comment"># ip add</span></span><br><span class="line">1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN group default qlen 1000</span><br><span class="line">    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00</span><br><span class="line">    inet 127.0.0.1/8 scope host lo</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">2: eth0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc pfifo_fast state UP group default qlen 1000</span><br><span class="line">    link/ether 52:54:00:c3:5f:7e brd ff:ff:ff:ff:ff:ff</span><br><span class="line">    inet 172.17.0.82/23 brd 172.17.1.255 scope global noprefixroute eth0</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">3: docker0: &lt;NO-CARRIER,BROADCAST,MULTICAST,UP&gt; mtu 1500 qdisc noqueue state DOWN group default </span><br><span class="line">    link/ether 02:42:48:39:11:70 brd ff:ff:ff:ff:ff:ff</span><br><span class="line">    inet 172.18.21.1/24 brd 172.18.21.255 scope global docker0</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">4: flannel.1: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1450 qdisc noqueue state UNKNOWN group default </span><br><span class="line">    link/ether 6e:a1:64:5c:ec:a3 brd ff:ff:ff:ff:ff:ff</span><br><span class="line">    inet 172.18.21.0/32 scope global flannel.1</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">       </span><br><span class="line"><span class="comment"># 从node1上ping测试node2的docker0网桥IP是否能通信</span></span><br><span class="line">[root@k8s-node1 ~]<span class="comment"># ping 172.18.43.1</span></span><br><span class="line">PING 172.18.43.1 (172.18.43.1) 56(84) bytes of data.</span><br><span class="line">64 bytes from 172.18.43.1: icmp_seq=1 ttl=64 time=0.496 ms</span><br><span class="line">64 bytes from 172.18.43.1: icmp_seq=2 ttl=64 time=0.522 ms</span><br></pre></td></tr></table></figure><h2 id="部署Master节点"><a href="#部署Master节点" class="headerlink" title="部署Master节点"></a>部署Master节点</h2><h3 id="Master组件简介"><a href="#Master组件简介" class="headerlink" title="Master组件简介"></a>Master组件简介</h3><ul><li><strong>kube-apiserver:</strong> Kubernetes API，集群的统一入口，各组件协调者，以RESTful API提供接口服务，所有对象资源的增删改查和监听操作都交给APIServer处理后再提交给Etcd存储。</li><li><strong>kube-controller-manager:</strong> 处理集群中常规后台任务，一个资源对应一个控制器，而ControllerManager就是负责管理这些控制器的。</li><li><strong>kube-scheduler:</strong> 根据调度算法为新创建的Pod选择一个Node节点，可以任意部署,可以部署在同一个节点上,也可以部署在不同的节点上</li></ul><p>kube-scheduler 和 kube-controller-manager 可以以集群模式运行，通过 leader 选举产生一个工作进程，其它进程处于阻塞模式。</p><h3 id="生成kubernetes证书"><a href="#生成kubernetes证书" class="headerlink" title="生成kubernetes证书"></a>生成kubernetes证书</h3><p>创建kubernetes CA证书</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-master ~]<span class="comment"># mkdir /root/kubernetes_ssl &amp;&amp; cd /root/kubernetes_ssl</span></span><br><span class="line">[root@k8s-master kubernetes_ssl]<span class="comment"># cat &lt;&lt; EOF | tee ca-config.json</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">"signing"</span>: &#123;</span><br><span class="line">    <span class="string">"default"</span>: &#123;</span><br><span class="line">      <span class="string">"expiry"</span>: <span class="string">"87600h"</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">"profiles"</span>: &#123;</span><br><span class="line">      <span class="string">"kubernetes"</span>: &#123;</span><br><span class="line">         <span class="string">"expiry"</span>: <span class="string">"87600h"</span>,</span><br><span class="line">         <span class="string">"usages"</span>: [</span><br><span class="line">            <span class="string">"signing"</span>,</span><br><span class="line">            <span class="string">"key encipherment"</span>,</span><br><span class="line">            <span class="string">"server auth"</span>,</span><br><span class="line">            <span class="string">"client auth"</span></span><br><span class="line">        ]</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">[root@k8s-master kubernetes_ssl]<span class="comment"># cat &lt;&lt; EOF | tee ca-csr.json</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="string">"CN"</span>: <span class="string">"kubernetes"</span>,</span><br><span class="line">    <span class="string">"key"</span>: &#123;</span><br><span class="line">        <span class="string">"algo"</span>: <span class="string">"rsa"</span>,</span><br><span class="line">        <span class="string">"size"</span>: 2048</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">"names"</span>: [</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="string">"C"</span>: <span class="string">"CN"</span>,</span><br><span class="line">            <span class="string">"L"</span>: <span class="string">"Shenzhen"</span>,</span><br><span class="line">            <span class="string">"ST"</span>: <span class="string">"Shenzhen"</span>,</span><br><span class="line">            <span class="string">"O"</span>: <span class="string">"k8s"</span>,</span><br><span class="line">            <span class="string">"OU"</span>: <span class="string">"System"</span></span><br><span class="line">        &#125;</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">[root@k8s-master kubernetes_ssl]<span class="comment"># cfssl gencert -initca ca-csr.json | cfssljson -bare ca -</span></span><br></pre></td></tr></table></figure><p>生成API Sercer证书</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-master kubernetes_ssl]<span class="comment"># cat &lt;&lt; EOF | tee server-csr.json</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="string">"CN"</span>: <span class="string">"kubernetes"</span>,</span><br><span class="line">    <span class="string">"hosts"</span>: [</span><br><span class="line">      <span class="string">"10.0.0.1"</span>,</span><br><span class="line">      <span class="string">"127.0.0.1"</span>,</span><br><span class="line">      <span class="string">"172.17.0.81"</span>,</span><br><span class="line">      <span class="string">"172.17.0.82"</span>,</span><br><span class="line">      <span class="string">"172.17.0.83"</span>,</span><br><span class="line">      <span class="string">"kubernetes"</span>,</span><br><span class="line">      <span class="string">"kubernetes.default"</span>,</span><br><span class="line">      <span class="string">"kubernetes.default.svc"</span>,</span><br><span class="line">      <span class="string">"kubernetes.default.svc.cluster"</span>,</span><br><span class="line">      <span class="string">"kubernetes.default.svc.cluster.local"</span></span><br><span class="line">    ],</span><br><span class="line">    <span class="string">"key"</span>: &#123;</span><br><span class="line">        <span class="string">"algo"</span>: <span class="string">"rsa"</span>,</span><br><span class="line">        <span class="string">"size"</span>: 2048</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">"names"</span>: [</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="string">"C"</span>: <span class="string">"CN"</span>,</span><br><span class="line">            <span class="string">"L"</span>: <span class="string">"Shenzhen"</span>,</span><br><span class="line">            <span class="string">"ST"</span>: <span class="string">"Shenzhen"</span>,</span><br><span class="line">            <span class="string">"O"</span>: <span class="string">"k8s"</span>,</span><br><span class="line">            <span class="string">"OU"</span>: <span class="string">"System"</span></span><br><span class="line">        &#125;</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">[root@k8s-master kubernetes_ssl]<span class="comment"># cfssl gencert -ca=ca.pem -ca-key=ca-key.pem -config=ca-config.json -profile=kubernetes server-csr.json | cfssljson -bare server</span></span><br></pre></td></tr></table></figure><p>创建Kubernetes Proxy证书</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-master kubernetes_ssl]<span class="comment"># cat &lt;&lt; EOF | tee kube-proxy-csr.json</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">"CN"</span>: <span class="string">"system:kube-proxy"</span>,</span><br><span class="line">  <span class="string">"hosts"</span>: [],</span><br><span class="line">  <span class="string">"key"</span>: &#123;</span><br><span class="line">    <span class="string">"algo"</span>: <span class="string">"rsa"</span>,</span><br><span class="line">    <span class="string">"size"</span>: 2048</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="string">"names"</span>: [</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="string">"C"</span>: <span class="string">"CN"</span>,</span><br><span class="line">      <span class="string">"L"</span>: <span class="string">"Shenzhen"</span>,</span><br><span class="line">      <span class="string">"ST"</span>: <span class="string">"Shenzhen"</span>,</span><br><span class="line">      <span class="string">"O"</span>: <span class="string">"k8s"</span>,</span><br><span class="line">      <span class="string">"OU"</span>: <span class="string">"System"</span></span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">[root@k8s-master kubernetes_ssl]<span class="comment"># cfssl gencert -ca=ca.pem -ca-key=ca-key.pem -config=ca-config.json -profile=kubernetes kube-proxy-csr.json | cfssljson -bare kube-proxy</span></span><br></pre></td></tr></table></figure><p>完成如上操作将会生成以下证书文件:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-master kubernetes_ssl]<span class="comment"># ls *.pem</span></span><br><span class="line">ca-key.pem  ca.pem  kube-proxy-key.pem  kube-proxy.pem  server-key.pem  server.pem</span><br><span class="line"></span><br><span class="line"><span class="comment"># 将证书拷贝到kubernetes工作目录</span></span><br><span class="line">[root@k8s-master kubernetes_ssl]<span class="comment"># cp *.pem /home/kubernetes/ssl/</span></span><br></pre></td></tr></table></figure><h3 id="部署-kube-apiserver-组件"><a href="#部署-kube-apiserver-组件" class="headerlink" title="部署 kube-apiserver 组件"></a>部署 kube-apiserver 组件</h3><p>到GitHub上下载二进制包<a href="https://github.com/kubernetes/kubernetes/blob/master/CHANGELOG-1.13.md" target="_blank" rel="noopener">https://github.com/kubernetes/kubernetes/blob/master/CHANGELOG-1.13.md</a></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-master ~]<span class="comment"># wget https://dl.k8s.io/v1.13.1/kubernetes-server-linux-amd64.tar.gz</span></span><br><span class="line">[root@k8s-master ~]<span class="comment"># tar zxf kubernetes-server-linux-amd64.tar.gz </span></span><br><span class="line">[root@k8s-master ~]<span class="comment"># cd kubernetes/server/bin/</span></span><br><span class="line">[root@k8s-master bin]<span class="comment"># cp kube-apiserver kube-scheduler kube-controller-manager kubectl /home/kubernetes/bin/</span></span><br></pre></td></tr></table></figure><p>创建 TLS Bootstrapping Token</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-master ~]<span class="comment"># head -c 16 /dev/urandom | od -An -t x | tr -d ' '</span></span><br><span class="line">1d02aaf678bee18f06a3bf1804715036</span><br><span class="line"></span><br><span class="line">[root@k8s-master ~]<span class="comment"># vim /home/kubernetes/cfg/token.csv</span></span><br><span class="line">1d02aaf678bee18f06a3bf1804715036,kubelet-bootstrap,10001,<span class="string">"system:kubelet-bootstrap"</span></span><br></pre></td></tr></table></figure><p>创建apiserver配置文件</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-master ~]<span class="comment"># vim /home/kubernetes/cfg/kube-apiserver</span></span><br><span class="line">KUBE_APISERVER_OPTS=<span class="string">"--logtostderr=true \</span></span><br><span class="line"><span class="string">--v=4 \</span></span><br><span class="line"><span class="string">--etcd-servers=https://172.17.0.81:2379,https://172.17.0.82:2379,https://172.17.0.83:2379 \</span></span><br><span class="line"><span class="string">--bind-address=172.17.0.81 \</span></span><br><span class="line"><span class="string">--secure-port=6443 \</span></span><br><span class="line"><span class="string">--advertise-address=172.17.0.81 \</span></span><br><span class="line"><span class="string">--allow-privileged=true \</span></span><br><span class="line"><span class="string">--service-cluster-ip-range=10.0.0.0/24 \</span></span><br><span class="line"><span class="string">--enable-admission-plugins=NamespaceLifecycle,LimitRanger,SecurityContextDeny,ServiceAccount,ResourceQuota,NodeRestriction \</span></span><br><span class="line"><span class="string">--authorization-mode=RBAC,Node \</span></span><br><span class="line"><span class="string">--enable-bootstrap-token-auth \</span></span><br><span class="line"><span class="string">--token-auth-file=/home/kubernetes/cfg/token.csv \</span></span><br><span class="line"><span class="string">--service-node-port-range=30000-50000 \</span></span><br><span class="line"><span class="string">--tls-cert-file=/home/kubernetes/ssl/server.pem  \</span></span><br><span class="line"><span class="string">--tls-private-key-file=/home/kubernetes/ssl/server-key.pem \</span></span><br><span class="line"><span class="string">--client-ca-file=/home/kubernetes/ssl/ca.pem \</span></span><br><span class="line"><span class="string">--service-account-key-file=/home/kubernetes/ssl/ca-key.pem \</span></span><br><span class="line"><span class="string">--etcd-cafile=/home/etcd/ssl/ca.pem \</span></span><br><span class="line"><span class="string">--etcd-certfile=/home/etcd/ssl/server.pem \</span></span><br><span class="line"><span class="string">--etcd-keyfile=/home/etcd/ssl/server-key.pem"</span></span><br></pre></td></tr></table></figure><p>参数说明：</p><ul><li><code>--logtostderr</code> 启用日志</li><li><code>---v</code> 日志等级</li><li><code>--etcd-servers</code> etcd集群地址</li><li><code>--bind-address</code> 监听地址</li><li><code>--secure-port</code> https安全端口</li><li><code>--advertise-address</code> 集群通告地址</li><li><code>--allow-privileged</code> 启用授权</li><li><code>--service-cluster-ip-range</code> Service虚拟IP地址段</li><li><code>--enable-admission-plugins</code> 准入控制模块</li><li><code>--authorization-mode</code> 认证授权，启用RBAC授权和节点自管理</li><li><code>--enable-bootstrap-token-auth</code> 启用TLS bootstrap功能，后面会讲到</li><li><code>--token-auth-file</code> token文件</li><li><code>--service-node-port-range</code> Service Node类型默认分配端口范围</li></ul><p>创建 kube-apiserver systemd unit 文件</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-master ~]<span class="comment"># vim /usr/lib/systemd/system/kube-apiserver.service </span></span><br><span class="line">[Unit]</span><br><span class="line">Description=Kubernetes API Server</span><br><span class="line">Documentation=https://github.com/kubernetes/kubernetes</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">EnvironmentFile=-/home/kubernetes/cfg/kube-apiserver</span><br><span class="line">ExecStart=/home/kubernetes/bin/kube-apiserver <span class="variable">$KUBE_APISERVER_OPTS</span></span><br><span class="line">Restart=on-failure</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br></pre></td></tr></table></figure><p>启动服务</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-master ~]<span class="comment"># systemctl daemon-reload</span></span><br><span class="line">[root@k8s-master ~]<span class="comment"># systemctl start kube-apiserver</span></span><br><span class="line">[root@k8s-master ~]<span class="comment"># systemctl enable kube-apiserver</span></span><br><span class="line">[root@k8s-master ~]<span class="comment"># systemctl status kube-apiserver</span></span><br></pre></td></tr></table></figure><h3 id="部署kube-scheduler"><a href="#部署kube-scheduler" class="headerlink" title="部署kube-scheduler"></a>部署kube-scheduler</h3><p>创建kube-scheduler配置文件</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-master ~]<span class="comment"># vim /home/kubernetes/cfg/kube-scheduler </span></span><br><span class="line">KUBE_SCHEDULER_OPTS=<span class="string">"--logtostderr=true --v=4 --master=127.0.0.1:8080 --leader-elect"</span></span><br></pre></td></tr></table></figure><ul><li><code>–address</code>：在 127.0.0.1:10251 端口接收 http /metrics 请求；kube-scheduler 目前还不支持接收 https 请求；</li><li><code>–kubeconfig</code>：指定 kubeconfig 文件路径，kube-scheduler 使用它连接和验证 kube-apiserver；</li><li><code>–leader-elect=true</code>：集群运行模式，启用选举功能；被选为 leader 的节点负责处理工作，其它节点为阻塞状态；</li></ul><p>创建kube-scheduler systemd unit 文件</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-master ~]<span class="comment"># vim /usr/lib/systemd/system/kube-scheduler.service</span></span><br><span class="line">[Unit]</span><br><span class="line">Description=Kubernetes Scheduler</span><br><span class="line">Documentation=https://github.com/kubernetes/kubernetes</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">EnvironmentFile=-/home/kubernetes/cfg/kube-scheduler</span><br><span class="line">ExecStart=/home/kubernetes/bin/kube-scheduler <span class="variable">$KUBE_SCHEDULER_OPTS</span></span><br><span class="line">Restart=on-failure</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br></pre></td></tr></table></figure><p>启动kuber-scheduler服务</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-master ~]<span class="comment"># systemctl daemon-reload</span></span><br><span class="line">[root@k8s-master ~]<span class="comment"># systemctl start kube-scheduler</span></span><br><span class="line">[root@k8s-master ~]<span class="comment"># systemctl enable kube-scheduler</span></span><br><span class="line">[root@k8s-master ~]<span class="comment"># systemctl status kube-scheduler</span></span><br></pre></td></tr></table></figure><h3 id="部署kube-controller-manager"><a href="#部署kube-controller-manager" class="headerlink" title="部署kube-controller-manager"></a>部署kube-controller-manager</h3><p>创建kube-controller-manager配置文件</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-master ~]<span class="comment"># vim /home/kubernetes/cfg/kube-controller-manager</span></span><br><span class="line">KUBE_CONTROLLER_MANAGER_OPTS=<span class="string">"--logtostderr=true \</span></span><br><span class="line"><span class="string">--v=4 \</span></span><br><span class="line"><span class="string">--master=127.0.0.1:8080 \</span></span><br><span class="line"><span class="string">--leader-elect=true \</span></span><br><span class="line"><span class="string">--address=127.0.0.1 \</span></span><br><span class="line"><span class="string">--service-cluster-ip-range=10.0.0.0/24 \</span></span><br><span class="line"><span class="string">--cluster-name=kubernetes \</span></span><br><span class="line"><span class="string">--cluster-signing-cert-file=/home/kubernetes/ssl/ca.pem \</span></span><br><span class="line"><span class="string">--cluster-signing-key-file=/home/kubernetes/ssl/ca-key.pem  \</span></span><br><span class="line"><span class="string">--root-ca-file=/home/kubernetes/ssl/ca.pem \</span></span><br><span class="line"><span class="string">--service-account-private-key-file=/home/kubernetes/ssl/ca-key.pem"</span></span><br></pre></td></tr></table></figure><p>创建kube-controller-manager systemd unit 文件</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-master ~]<span class="comment"># vim /usr/lib/systemd/system/kube-controller-manager.service</span></span><br><span class="line">[Unit]</span><br><span class="line">Description=Kubernetes Controller Manager</span><br><span class="line">Documentation=https://github.com/kubernetes/kubernetes</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">EnvironmentFile=-/home/kubernetes/cfg/kube-controller-manager</span><br><span class="line">ExecStart=/home/kubernetes/bin/kube-controller-manager <span class="variable">$KUBE_CONTROLLER_MANAGER_OPTS</span></span><br><span class="line">Restart=on-failure</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br></pre></td></tr></table></figure><p>启动controller-manager服务</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-master ~]# systemctl daemon-reload</span><br><span class="line">[root@k8s-master ~]# systemctl start kube-controller-manager</span><br><span class="line">[root@k8s-master ~]# systemctl enable kube-controller-manager</span><br><span class="line">[root@k8s-master ~]# systemctl status kube-controller-manager</span><br></pre></td></tr></table></figure><h3 id="查看master集群状态"><a href="#查看master集群状态" class="headerlink" title="查看master集群状态"></a>查看master集群状态</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-master ~]# kubectl get cs,nodes</span><br><span class="line">NAME                                 STATUS    MESSAGE             ERROR</span><br><span class="line">componentstatus/scheduler            Healthy   ok                  </span><br><span class="line">componentstatus/controller-manager   Healthy   ok                  </span><br><span class="line">componentstatus/etcd-2               Healthy   &#123;&quot;health&quot;:&quot;true&quot;&#125;   </span><br><span class="line">componentstatus/etcd-1               Healthy   &#123;&quot;health&quot;:&quot;true&quot;&#125;   </span><br><span class="line">componentstatus/etcd-0               Healthy   &#123;&quot;health&quot;:&quot;true&quot;&#125;</span><br></pre></td></tr></table></figure><h2 id="部署Node-节点"><a href="#部署Node-节点" class="headerlink" title="部署Node 节点"></a>部署Node 节点</h2><h3 id="Node组件简介"><a href="#Node组件简介" class="headerlink" title="Node组件简介"></a>Node组件简介</h3><ul><li><strong>kubelet:</strong> kubelet是Master在Node节点上的Agent，管理本机运行容器的生命周期，比如创建容器、Pod挂载数据卷、下载secret、获取容器和节点状态等工作。kubelet将每个Pod转换成一组容器。</li><li><strong>kube-proxy:</strong> 在Node节点上实现Pod网络代理，维护网络规则和四层负载均衡工作。</li><li><strong>docker：</strong> 容器引擎</li><li><strong>etcd:</strong> 分布式键值存储系统。用于保存集群状态数据，比如Pod、Service等对象信息。</li></ul><p>将kubelet二进制文件拷贝到node节点上</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-master ~]<span class="comment"># scp kubernetes/server/bin/&#123;kubelet,kube-proxy&#125; k8s-node1:/home/kubernetes/bin/</span></span><br><span class="line">[root@k8s-master ~]<span class="comment"># scp kubernetes/server/bin/&#123;kubelet,kube-proxy&#125; k8s-node2:/home/kubernetes/bin/</span></span><br></pre></td></tr></table></figure><h3 id="部署kubelet组件"><a href="#部署kubelet组件" class="headerlink" title="部署kubelet组件"></a>部署kubelet组件</h3><p>创建 kubelet bootstrap kubeconfig 文件<br></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-master ~]<span class="comment"># cd kubernetes_ssl/</span></span><br><span class="line">[root@k8s-master kubernetes_ssl]<span class="comment"># BOOTSTRAP_TOKEN=1d02aaf678bee18f06a3bf1804715036</span></span><br><span class="line">[root@k8s-master kubernetes_ssl]<span class="comment"># KUBE_APISERVER="172.17.0.81:6443"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 设置集群参数</span></span><br><span class="line">kubectl config <span class="built_in">set</span>-cluster kubernetes \</span><br><span class="line">  --certificate-authority=./ca.pem \</span><br><span class="line">  --embed-certs=<span class="literal">true</span> \</span><br><span class="line">  --server=<span class="variable">$&#123;KUBE_APISERVER&#125;</span> \</span><br><span class="line">  --kubeconfig=bootstrap.kubeconfig</span><br><span class="line"></span><br><span class="line"><span class="comment"># 设置客户端认证参数</span></span><br><span class="line">kubectl config <span class="built_in">set</span>-credentials kubelet-bootstrap \</span><br><span class="line">  --token=<span class="variable">$&#123;BOOTSTRAP_TOKEN&#125;</span> \</span><br><span class="line">  --kubeconfig=bootstrap.kubeconfig</span><br><span class="line"></span><br><span class="line"><span class="comment"># 设置上下文参数</span></span><br><span class="line">kubectl config <span class="built_in">set</span>-context default \</span><br><span class="line">  --cluster=kubernetes \</span><br><span class="line">  --user=kubelet-bootstrap \</span><br><span class="line">  --kubeconfig=bootstrap.kubeconfig</span><br><span class="line"></span><br><span class="line"><span class="comment"># 设置默认上下文</span></span><br><span class="line">kubectl config use-context default --kubeconfig=bootstrap.kubeconfig</span><br><span class="line"></span><br><span class="line"><span class="comment">#----------------------</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建kube-proxy kubeconfig文件</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">kubectl config <span class="built_in">set</span>-cluster kubernetes \</span><br><span class="line">  --certificate-authority=./ca.pem \</span><br><span class="line">  --embed-certs=<span class="literal">true</span> \</span><br><span class="line">  --server=<span class="variable">$&#123;KUBE_APISERVER&#125;</span> \</span><br><span class="line">  --kubeconfig=kube-proxy.kubeconfig</span><br><span class="line"></span><br><span class="line">kubectl config <span class="built_in">set</span>-credentials kube-proxy \</span><br><span class="line">  --client-certificate=./kube-proxy.pem \</span><br><span class="line">  --client-key=./kube-proxy-key.pem \</span><br><span class="line">  --embed-certs=<span class="literal">true</span> \</span><br><span class="line">  --kubeconfig=kube-proxy.kubeconfig</span><br><span class="line"></span><br><span class="line">kubectl config <span class="built_in">set</span>-context default \</span><br><span class="line">  --cluster=kubernetes \</span><br><span class="line">  --user=kube-proxy \</span><br><span class="line">  --kubeconfig=kube-proxy.kubeconfig</span><br><span class="line"></span><br><span class="line">kubectl config use-context default --kubeconfig=kube-proxy.kubeconfig</span><br><span class="line"></span><br><span class="line">[root@k8s-master kubernetes_ssl]<span class="comment"># ls *.kubeconfig</span></span><br><span class="line">bootstrap.kubeconfig  kube-proxy.kubeconfig</span><br></pre></td></tr></table></figure><p></p><p>将bootstrap kubeconfig kube-proxy.kubeconfig 文件拷贝到所有 nodes节点</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-master kubernetes_ssl]<span class="comment"># scp *.pem k8s-node1:/home/kubernetes/ssl/</span></span><br><span class="line">[root@k8s-master kubernetes_ssl]<span class="comment"># scp *.pem k8s-node2:/home/kubernetes/ssl/</span></span><br><span class="line">[root@k8s-master kubernetes_ssl]<span class="comment"># scp *.kubeconfig k8s-node1:/home/kubernetes/cfg/</span></span><br><span class="line">[root@k8s-master kubernetes_ssl]<span class="comment"># scp *.kubeconfig k8s-node2:/home/kubernetes/cfg/</span></span><br></pre></td></tr></table></figure><p>创建 kubelet 参数配置模板文件：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-node1 ~]<span class="comment"># vim /home/kubernetes/cfg/kubelet.config</span></span><br><span class="line">kind: KubeletConfiguration</span><br><span class="line">apiVersion: kubelet.config.k8s.io/v1beta1</span><br><span class="line">address: 172.17.0.82</span><br><span class="line">port: 10250</span><br><span class="line">readOnlyPort: 10255</span><br><span class="line">cgroupDriver: cgroupfs</span><br><span class="line">clusterDNS: [<span class="string">"10.0.0.2"</span>]</span><br><span class="line">clusterDomain: cluster.local.</span><br><span class="line">failSwapOn: <span class="literal">false</span></span><br><span class="line">authentication:</span><br><span class="line">  anonymous:</span><br><span class="line">    enabled: <span class="literal">true</span></span><br></pre></td></tr></table></figure><p>创建kubelet配置文件</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-node1 ~]<span class="comment"># vim /home/kubernetes/cfg/kubelet</span></span><br><span class="line">KUBELET_OPTS=<span class="string">"--logtostderr=true \</span></span><br><span class="line"><span class="string">--v=4 \</span></span><br><span class="line"><span class="string">--hostname-override=172.17.0.82 \</span></span><br><span class="line"><span class="string">--kubeconfig=/home/kubernetes/cfg/kubelet.kubeconfig \</span></span><br><span class="line"><span class="string">--bootstrap-kubeconfig=/home/kubernetes/cfg/bootstrap.kubeconfig \</span></span><br><span class="line"><span class="string">--config=/home/kubernetes/cfg/kubelet.config \</span></span><br><span class="line"><span class="string">--cert-dir=/home/kubernetes/ssl \</span></span><br><span class="line"><span class="string">--pod-infra-container-image=registry.cn-hangzhou.aliyuncs.com/google-containers/pause-amd64:3.0"</span></span><br></pre></td></tr></table></figure><p>参数说明：</p><ul><li><code>--hostname-override</code> 在集群中显示的主机名</li><li><code>--kubeconfig</code> 指定kubeconfig文件位置，会自动生成</li><li><code>--bootstrap-kubeconfig</code> 指定刚才生成的bootstrap.kubeconfig文件</li><li><code>--cert-dir</code> 颁发证书存放位置</li><li><code>--cluster-dns</code> 集群DNS IP，先配置上，后面会讲到</li><li><code>--cluster-domain</code> DNS域</li><li><code>--fail-swap-on=false</code> 禁止使用swap</li><li><code>--pod-infra-container-image</code> 管理Pod网络的镜像</li></ul><p>创建kubelet systemd unit 文件</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-node1 ~]<span class="comment"># vim /usr/lib/systemd/system/kubelet.service</span></span><br><span class="line">[Unit]</span><br><span class="line">Description=Kubernetes Kubelet</span><br><span class="line">After=docker.service</span><br><span class="line">Requires=docker.service</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">EnvironmentFile=/home/kubernetes/cfg/kubelet</span><br><span class="line">ExecStart=/home/kubernetes/bin/kubelet <span class="variable">$KUBELET_OPTS</span></span><br><span class="line">Restart=on-failure</span><br><span class="line">KillMode=process</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br></pre></td></tr></table></figure><p>将kubelet-bootstrap用户绑定到系统集群角色</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-master ~]<span class="comment"># kubectl create clusterrolebinding kubelet-bootstrap \</span></span><br><span class="line">--clusterrole=system:node-bootstrapper \</span><br><span class="line">--user=kubelet-bootstrap</span><br><span class="line"></span><br><span class="line"><span class="comment"># 输出内容</span></span><br><span class="line">clusterrolebinding.rbac.authorization.k8s.io/kubelet-bootstrap created</span><br></pre></td></tr></table></figure><p>启动kubelet服务</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-node1 ~]<span class="comment"># systemctl daemon-reload                     </span></span><br><span class="line">[root@k8s-node1 ~]<span class="comment"># systemctl start kubelet                     </span></span><br><span class="line">[root@k8s-node1 ~]<span class="comment"># systemctl enable kubelet</span></span><br><span class="line">[root@k8s-node1 ~]<span class="comment"># systemctl status kubelet</span></span><br></pre></td></tr></table></figure><h3 id="approve-kubelet-CSR-请求"><a href="#approve-kubelet-CSR-请求" class="headerlink" title="approve kubelet CSR 请求"></a>approve kubelet CSR 请求</h3><p>可以手动或自动 approve CSR 请求。推荐使用自动的方式，因为从 v1.8 版本开始，可以自动轮转approve csr 后生成的证书。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 查看 CSR 列表：</span></span><br><span class="line">[root@k8s-master ~]<span class="comment"># kubectl get csr</span></span><br><span class="line">NAME                                                   AGE       REQUESTOR           CONDITION</span><br><span class="line">node-csr-W9gLNYYT3Nk4b8rRysAqFCKfTcBtm_KJgNeZ-14L3e0   1m        kubelet-bootstrap   Pending</span><br><span class="line">node-csr-u1zKoBmUWwqCRMlQi_tbgbMX-63kZ7IrYNnAz0FgEUg   55s       kubelet-bootstrap   Pending</span><br><span class="line"></span><br><span class="line"><span class="comment"># 手动 approve CSR 请求</span></span><br><span class="line">[root@k8s-master ~]<span class="comment"># kubectl certificate approve node-csr-W9gLNYYT3Nk4b8rRysAqFCKfTcBtm_KJgNeZ-14L3e0</span></span><br><span class="line"></span><br><span class="line">[root@k8s-master ~]<span class="comment"># kubectl certificate approve node-csr-u1zKoBmUWwqCRMlQi_tbgbMX-63kZ7IrYNnAz0FgEUg</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看 CSR 列表：</span></span><br><span class="line">[root@k8s-master ~]<span class="comment"># kubectl get csr</span></span><br><span class="line">NAME                                                   AGE       REQUESTOR           CONDITION</span><br><span class="line">node-csr-W9gLNYYT3Nk4b8rRysAqFCKfTcBtm_KJgNeZ-14L3e0   2m        kubelet-bootstrap   Approved,Issued</span><br><span class="line">node-csr-u1zKoBmUWwqCRMlQi_tbgbMX-63kZ7IrYNnAz0FgEUg   1m        kubelet-bootstrap   Approved,Issued</span><br></pre></td></tr></table></figure><h3 id="部署-kube-proxy-组件"><a href="#部署-kube-proxy-组件" class="headerlink" title="部署 kube-proxy 组件"></a>部署 kube-proxy 组件</h3><p>kube-proxy 运行在所有 node节点上，它监听 apiserver 中 service 和 Endpoint 的变化情况，创建路由规则来进行服务负载均衡</p><p>创建 kube-proxy 配置文件<br></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-node1 ~]<span class="comment"># vim /home/kubernetes/cfg/kube-proxy</span></span><br><span class="line">KUBE_PROXY_OPTS=<span class="string">"--logtostderr=true \</span></span><br><span class="line"><span class="string">--v=4 \</span></span><br><span class="line"><span class="string">--hostname-override=172.17.0.82 \</span></span><br><span class="line"><span class="string">--cluster-cidr=10.0.0.0/24 \</span></span><br><span class="line"><span class="string">--kubeconfig=/home/kubernetes/cfg/kube-proxy.kubeconfig"</span></span><br></pre></td></tr></table></figure><p></p><p>参数说明：</p><ul><li><code>bindAddress</code>: 监听地址；</li><li><code>clientConnection.kubeconfig</code>: 连接 apiserver 的 kubeconfig 文件；</li><li><code>clusterCIDR</code>: kube-proxy 根据 –cluster-cidr 判断集群内部和外部流量，指定 –cluster-cidr 或 –masquerade-all 选项后 kube-proxy 才会对访问 Service IP 的请求做 SNAT；</li><li><code>hostnameOverride</code>: 参数值必须与 kubelet 的值一致，否则 kube-proxy 启动后会找不到该 Node，从而不会创建任何 ipvs 规则；</li><li><code>mode</code>: 使用 ipvs 模式；</li></ul><p>创建kube-proxy systemd unit 文件<br></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-node1 ~]# vim /usr/lib/systemd/system/kube-proxy.service </span><br><span class="line">[Unit]</span><br><span class="line">Description=Kubernetes Proxy</span><br><span class="line">After=network.target</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">EnvironmentFile=-/home/kubernetes/cfg/kube-proxy</span><br><span class="line">ExecStart=/home/kubernetes/bin/kube-proxy $KUBE_PROXY_OPTS</span><br><span class="line">Restart=on-failure</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br></pre></td></tr></table></figure><p></p><p>启动kube-proxy服务<br></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-node1 ~]<span class="comment"># systemctl daemon-reload</span></span><br><span class="line">[root@k8s-node1 ~]<span class="comment"># systemctl enable kube-proxy</span></span><br><span class="line">Created symlink from /etc/systemd/system/multi-user.target.wants/kube-proxy.service to /usr/lib/systemd/system/kube-proxy.service.</span><br><span class="line">[root@k8s-node1 ~]<span class="comment"># systemctl restart kube-proxy</span></span><br></pre></td></tr></table></figure><p></p><h3 id="查看集群状态"><a href="#查看集群状态" class="headerlink" title="查看集群状态"></a>查看集群状态</h3><p>给node节点配置label标签<br></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-master ~]<span class="comment"># kubectl label node 172.17.0.82 node-role.kubernetes.io/node='node1'        </span></span><br><span class="line">[root@k8s-master ~]<span class="comment"># kubectl label node 172.17.0.83 node-role.kubernetes.io/node='node2'</span></span><br></pre></td></tr></table></figure><p></p><p>查看集群及node节点状态<br></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-master ~]<span class="comment"># kubectl get node,cs</span></span><br><span class="line">NAME               STATUS    ROLES     AGE       VERSION</span><br><span class="line">node/172.17.0.82   Ready     node      29m       v1.11.5</span><br><span class="line">node/172.17.0.83   Ready     node      36m       v1.11.5</span><br><span class="line"></span><br><span class="line">NAME                                 STATUS    MESSAGE             ERROR</span><br><span class="line">componentstatus/scheduler            Healthy   ok                  </span><br><span class="line">componentstatus/controller-manager   Healthy   ok                  </span><br><span class="line">componentstatus/etcd-0               Healthy   &#123;<span class="string">"health"</span>:<span class="string">"true"</span>&#125;   </span><br><span class="line">componentstatus/etcd-1               Healthy   &#123;<span class="string">"health"</span>:<span class="string">"true"</span>&#125;   </span><br><span class="line">componentstatus/etcd-2               Healthy   &#123;<span class="string">"health"</span>:<span class="string">"true"</span>&#125;</span><br></pre></td></tr></table></figure><p></p></div><div class="article-footer"><blockquote class="mt-2x"><ul class="post-copyright list-unstyled"><li class="post-copyright-link hidden-xs"><strong>本文链接：</strong> <a href="http://blog.wubolive.com/2018/12/25/kubernetes1.13/" title="源码安装Kubernetes1.13" target="_blank" rel="external">http://blog.wubolive.com/2018/12/25/kubernetes1.13/</a></li><li class="post-copyright-license"><strong>版权声明： </strong>本博客所有文章除特别声明外，均采用 <a href="http://creativecommons.org/licenses/by/4.0/deed.zh" target="_blank" rel="external">CC BY 4.0 CN协议</a> 许可协议。转载请注明出处！</li></ul></blockquote><div class="panel panel-default panel-badger"><div class="panel-body"><figure class="media"><div class="media-left"><a href="https://github.com/wubolive" target="_blank" class="img-burn thumb-sm visible-lg"><img src="/images/avatar.jpg" class="img-rounded w-full" alt=""></a></div><div class="media-body"><h3 class="media-heading"><a href="https://github.com/wubolive" target="_blank"><span class="text-dark">Wave</span><small class="ml-1x">Linux operation</small></a></h3><div>来自南方的Linux运维小哥</div></div></figure></div></div></div></article><section id="comments"></section></div><nav class="bar bar-footer clearfix" data-stick-bottom=""><div class="bar-inner"><ul class="pager pull-left"><li class="next"><a href="/2018/12/18/k8s-pod-error/" title="Kubernetes 排错之 Pod 异常"><span>下一篇&nbsp;&nbsp;</span><i class="icon icon-angle-right" aria-hidden="true"></i></a></li><li class="toggle-toc"><a class="toggle-btn collapsed" data-toggle="collapse" href="#collapseToc" aria-expanded="false" title="文章目录" role="button"><span>[&nbsp;</span><span>文章目录</span> <i class="text-collapsed icon icon-anchor"></i> <i class="text-in icon icon-close"></i> <span>]</span></a></li></ul><button type="button" class="btn btn-fancy btn-donate pop-onhover bg-gradient-warning" data-toggle="modal" data-target="#donateModal"><span>赏</span></button><div class="bar-right"><div class="share-component" data-sites="weibo,qq,wechat,facebook,twitter" data-mobile-sites="weibo,qq,qzone"></div></div></div></nav><div class="modal modal-center modal-small modal-xs-full fade" id="donateModal" tabindex="-1" role="dialog"><div class="modal-dialog" role="document"><div class="modal-content donate"><button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button><div class="modal-body"><div class="donate-box"><div class="donate-head"><p>感谢您的支持，我会继续努力的!</p></div><div class="tab-content"><div role="tabpanel" class="tab-pane fade active in" id="alipay"><div class="donate-payimg"><img src="/images/donate/alipayimg.png" alt="扫码支持" title="扫一扫"></div><p class="text-muted mv">扫码打赏，你说多少就多少</p><p class="text-grey">打开支付宝扫一扫，即可进行扫码打赏哦</p></div><div role="tabpanel" class="tab-pane fade" id="wechatpay"><div class="donate-payimg"><img src="/images/donate/wechatpayimg.png" alt="扫码支持" title="扫一扫"></div><p class="text-muted mv">扫码打赏，你说多少就多少</p><p class="text-grey">打开微信扫一扫，即可进行扫码打赏哦</p></div></div><div class="donate-footer"><ul class="nav nav-tabs nav-justified" role="tablist"><li role="presentation" class="active"><a href="#alipay" id="alipay-tab" role="tab" data-toggle="tab" aria-controls="alipay" aria-expanded="true"><i class="icon icon-alipay"></i> 支付宝</a></li><li role="presentation"><a href="#wechatpay" role="tab" id="wechatpay-tab" data-toggle="tab" aria-controls="wechatpay" aria-expanded="false"><i class="icon icon-wepay"></i> 微信支付</a></li></ul></div></div></div></div></div></div></main><footer class="footer" itemscope itemtype="http://schema.org/WPFooter"><ul class="social-links"><li><a href="https://github.com/wubolive" target="_blank" title="Github" data-toggle="tooltip" data-placement="top"><i class="icon icon-github"></i></a></li><li><a href="http://weibo.com/cofess" target="_blank" title="Weibo" data-toggle="tooltip" data-placement="top"><i class="icon icon-weibo"></i></a></li><li><a href="https://twitter.com/iwebued" target="_blank" title="Twitter" data-toggle="tooltip" data-placement="top"><i class="icon icon-twitter"></i></a></li><li><a href="https://www.behance.net/cofess" target="_blank" title="Behance" data-toggle="tooltip" data-placement="top"><i class="icon icon-behance"></i></a></li><li><a href="/atom.xml" target="_blank" title="Rss" data-toggle="tooltip" data-placement="top"><i class="icon icon-rss"></i></a></li></ul><div class="copyright">&copy; 2018 John Doe<div class="publishby">Theme by <a href="https://github.com/cofess" target="_blank">cofess </a>base on <a href="https://github.com/cofess/hexo-theme-pure" target="_blank">pure</a>.</div></div></footer><script src="//cdn.jsdelivr.net/npm/jquery@1.12.4/dist/jquery.min.js"></script><script>window.jQuery||document.write('<script src="js/jquery.min.js"><\/script>')</script><script src="/js/plugin.min.js"></script><script src="/js/application.js"></script><script>!function(T){var N={TRANSLATION:{POSTS:"文章",PAGES:"页面",CATEGORIES:"分类",TAGS:"标签",UNTITLED:"(未命名)"},ROOT_URL:"/",CONTENT_URL:"/content.json"};T.INSIGHT_CONFIG=N}(window)</script><script src="/js/insight.js"></script><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><script src="//cdn.jsdelivr.net/npm/gitalk@1.4.0/dist/gitalk.min.js"></script><script src="//cdn.jsdelivr.net/npm/blueimp-md5@2.10.0/js/md5.min.js"></script><script type="text/javascript">var gitalk=new Gitalk({clientID:"66aca292843079a69ab9",clientSecret:"3e21c396b030f09b747aab6610530199f7fdd956",repo:"wubolive.github.io",owner:"wubolive",admin:["wubolive"],id:md5(location.pathname),distractionFreeMode:!0});gitalk.render("comments")</script></body></html><!-- rebuild by neat -->