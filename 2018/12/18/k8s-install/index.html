<!-- build time:Tue Dec 18 2018 19:16:40 GMT+0800 (中国标准时间) --><!DOCTYPE html><html lang="zh"><head><meta name="generator" content="Hexo 3.8.0"><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,minimum-scale=1,user-scalable=no,minimal-ui"><meta name="renderer" content="webkit"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="black"><meta name="format-detection" content="telephone=no,email=no,adress=no"><meta name="theme-color" content="#000000"><meta http-equiv="window-target" content="_top"><title>高可用源码部署Kubernetes | Wave Blog</title><meta name="description" content="角色IP组件镜像仓库hub.wubolive.comHarbork8s-master1192.168.0.11kube-apiserver,kube-controller-manage,kube-scheduler,etcd,keepalivedk8s-master2192.168.0.12kube-apiserver,kube-controller-manage,kube-scheduler,e"><meta name="keywords" content="K8s,Docker"><meta property="og:type" content="article"><meta property="og:title" content="高可用源码部署Kubernetes"><meta property="og:url" content="http://blog.wubolive.com/2018/12/18/k8s-install/index.html"><meta property="og:site_name" content="Hexo"><meta property="og:description" content="角色IP组件镜像仓库hub.wubolive.comHarbork8s-master1192.168.0.11kube-apiserver,kube-controller-manage,kube-scheduler,etcd,keepalivedk8s-master2192.168.0.12kube-apiserver,kube-controller-manage,kube-scheduler,e"><meta property="og:locale" content="zh-CN"><meta property="og:image" content="leanote://file/getImage?fileId=5c1209c6ab6441071500229f"><meta property="og:updated_time" content="2018-12-18T10:45:47.063Z"><meta name="twitter:card" content="summary"><meta name="twitter:title" content="高可用源码部署Kubernetes"><meta name="twitter:description" content="角色IP组件镜像仓库hub.wubolive.comHarbork8s-master1192.168.0.11kube-apiserver,kube-controller-manage,kube-scheduler,etcd,keepalivedk8s-master2192.168.0.12kube-apiserver,kube-controller-manage,kube-scheduler,e"><meta name="twitter:image" content="leanote://file/getImage?fileId=5c1209c6ab6441071500229f"><link rel="canonical" href="http://blog.wubolive.com/2018/12/18/k8s-install/index.html"><link rel="alternate" href="/atom.xml" title="Hexo" type="application/atom+xml"><link rel="icon" href="/favicon.png" type="image/x-icon"><link rel="stylesheet" href="/css/style.css"><link rel="stylesheet" href="//cdn.jsdelivr.net/npm/gitalk@1.4.0/dist/gitalk.min.css"></head><body class="main-center" itemscope itemtype="http://schema.org/WebPage"><header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="slimContent"><div class="navbar-header"><div class="profile-block text-center"><a id="avatar" href="https://github.com/wubolive" target="_blank"><img class="img-circle img-rotate" src="/images/avatar.jpg" width="200" height="200"></a><h2 id="name" class="hidden-xs hidden-sm">Wave</h2><h3 id="title" class="hidden-xs hidden-sm hidden-md">Linux operation</h3><small id="location" class="text-muted hidden-xs hidden-sm"><i class="icon icon-map-marker"></i> BeiJing, China</small></div><div class="search" id="search-form-wrap"><form class="search-form sidebar-form"><div class="input-group"><input type="text" class="search-form-input form-control" placeholder="搜索"> <span class="input-group-btn"><button type="submit" class="search-form-submit btn btn-flat" onclick="return!1"><i class="icon icon-search"></i></button></span></div></form><div class="ins-search"><div class="ins-search-mask"></div><div class="ins-search-container"><div class="ins-input-wrapper"><input type="text" class="ins-search-input" placeholder="想要查找什么..." x-webkit-speech=""> <button type="button" class="close ins-close ins-selectable" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">×</span></button></div><div class="ins-section-wrapper"><div class="ins-section-container"></div></div></div></div></div><button class="navbar-toggle collapsed" type="button" data-toggle="collapse" data-target="#main-navbar" aria-controls="main-navbar" aria-expanded="false"><span class="sr-only">Toggle navigation</span> <span class="icon-bar"></span> <span class="icon-bar"></span> <span class="icon-bar"></span></button></div><nav id="main-navbar" class="collapse navbar-collapse" itemscope itemtype="http://schema.org/SiteNavigationElement" role="navigation"><ul class="nav navbar-nav main-nav"><li class="menu-item menu-item-home"><a href="/."><i class="icon icon-home-fill"></i> <span class="menu-title">首页</span></a></li><li class="menu-item menu-item-archives"><a href="/archives"><i class="icon icon-archives-fill"></i> <span class="menu-title">归档</span></a></li><li class="menu-item menu-item-categories"><a href="/categories"><i class="icon icon-folder"></i> <span class="menu-title">分类</span></a></li><li class="menu-item menu-item-tags"><a href="/tags"><i class="icon icon-tags"></i> <span class="menu-title">标签</span></a></li><li class="menu-item menu-item-repository"><a href="/repository"><i class="icon icon-project"></i> <span class="menu-title">项目</span></a></li><li class="menu-item menu-item-links"><a href="/links"><i class="icon icon-friendship"></i> <span class="menu-title">友链</span></a></li><li class="menu-item menu-item-about"><a href="/about"><i class="icon icon-cup-fill"></i> <span class="menu-title">关于</span></a></li></ul><ul class="social-links"><li><a href="https://github.com/wubolive" target="_blank" title="Github" data-toggle="tooltip" data-placement="top"><i class="icon icon-github"></i></a></li><li><a href="http://weibo.com/cofess" target="_blank" title="Weibo" data-toggle="tooltip" data-placement="top"><i class="icon icon-weibo"></i></a></li><li><a href="https://twitter.com/iwebued" target="_blank" title="Twitter" data-toggle="tooltip" data-placement="top"><i class="icon icon-twitter"></i></a></li><li><a href="https://www.behance.net/cofess" target="_blank" title="Behance" data-toggle="tooltip" data-placement="top"><i class="icon icon-behance"></i></a></li><li><a href="/atom.xml" target="_blank" title="Rss" data-toggle="tooltip" data-placement="top"><i class="icon icon-rss"></i></a></li></ul></nav></div></header><aside class="sidebar" itemscope itemtype="http://schema.org/WPSideBar"><div class="slimContent"><div class="widget"><h3 class="widget-title">公告</h3><div class="widget-body"><div id="board"><div class="content"><p>欢迎交流与分享经验!</p></div></div></div></div><div class="widget"><h3 class="widget-title">分类</h3><div class="widget-body"><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/Ansable/">Ansable</a><span class="category-list-count">3</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/K8s/">K8s</a><span class="category-list-count">4</span><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/K8s/Docker/">Docker</a><span class="category-list-count">3</span></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/Kvm/">Kvm</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Linux/">Linux</a><span class="category-list-count">4</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/MQ/">MQ</a><span class="category-list-count">1</span></li></ul></div></div><div class="widget"><h3 class="widget-title">标签</h3><div class="widget-body"><ul class="tag-list"><li class="tag-list-item"><a class="tag-list-link" href="/tags/Ansible/">Ansible</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Docker/">Docker</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/FTP/">FTP</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/K8s/">K8s</a><span class="tag-list-count">4</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Kvm/">Kvm</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Linux/">Linux</a><span class="tag-list-count">8</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/NFS/">NFS</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Vnc/">Vnc</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/rabbitMQ/">rabbitMQ</a><span class="tag-list-count">1</span></li></ul></div></div><div class="widget"><h3 class="widget-title">标签云</h3><div class="widget-body tagcloud"><a href="/tags/Ansible/" style="font-size:13.5px">Ansible</a> <a href="/tags/Docker/" style="font-size:13.5px">Docker</a> <a href="/tags/FTP/" style="font-size:13px">FTP</a> <a href="/tags/K8s/" style="font-size:13.75px">K8s</a> <a href="/tags/Kvm/" style="font-size:13px">Kvm</a> <a href="/tags/Linux/" style="font-size:14px">Linux</a> <a href="/tags/NFS/" style="font-size:13px">NFS</a> <a href="/tags/Vnc/" style="font-size:13.25px">Vnc</a> <a href="/tags/rabbitMQ/" style="font-size:13px">rabbitMQ</a></div></div><div class="widget"><h3 class="widget-title">归档</h3><div class="widget-body"><ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/12/">十二月 2018</a><span class="archive-list-count">9</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/11/">十一月 2018</a><span class="archive-list-count">4</span></li></ul></div></div><div class="widget"><h3 class="widget-title">最新文章</h3><div class="widget-body"><ul class="recent-post-list list-unstyled no-thumbnail"><li><div class="item-inner"><p class="item-category"><a class="category-link" href="/categories/K8s/">K8s</a></p><p class="item-title"><a href="/2018/12/18/k8s-pod-error/" class="title">Kubernetes 排错之 Pod 异常</a></p><p class="item-date"><time datetime="2018-12-18T11:26:22.000Z" itemprop="datePublished">2018-12-18</time></p></div></li><li><div class="item-inner"><p class="item-category"><a class="category-link" href="/categories/K8s/">K8s</a><i class="icon icon-angle-right"></i><a class="category-link" href="/categories/K8s/Docker/">Docker</a></p><p class="item-title"><a href="/2018/12/18/k8s-install/" class="title">高可用源码部署Kubernetes</a></p><p class="item-date"><time datetime="2018-12-18T08:17:28.000Z" itemprop="datePublished">2018-12-18</time></p></div></li><li><div class="item-inner"><p class="item-category"><a class="category-link" href="/categories/Linux/">Linux</a></p><p class="item-title"><a href="/2018/12/07/nfs-install/" class="title">CentOS6 安装nfs共享目录服务</a></p><p class="item-date"><time datetime="2018-12-07T09:13:28.000Z" itemprop="datePublished">2018-12-07</time></p></div></li><li><div class="item-inner"><p class="item-category"><a class="category-link" href="/categories/Linux/">Linux</a></p><p class="item-title"><a href="/2018/12/07/vnc-pord/" class="title">vncserver端口占用解决方法</a></p><p class="item-date"><time datetime="2018-12-07T09:00:28.000Z" itemprop="datePublished">2018-12-07</time></p></div></li><li><div class="item-inner"><p class="item-category"><a class="category-link" href="/categories/MQ/">MQ</a></p><p class="item-title"><a href="/2018/12/07/rebbitmq-install/" class="title">rabbitMQ 安装</a></p><p class="item-date"><time datetime="2018-12-07T07:00:28.000Z" itemprop="datePublished">2018-12-07</time></p></div></li></ul></div></div></div></aside><aside class="sidebar sidebar-toc collapse" id="collapseToc" itemscope itemtype="http://schema.org/WPSideBar"><div class="slimContent"><nav id="toc" class="article-toc"><h3 class="toc-title">文章目录</h3><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#简介"><span class="toc-number">1.</span> <span class="toc-text">简介</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Master组件"><span class="toc-number">1.1.</span> <span class="toc-text">Master组件</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Node组件"><span class="toc-number">1.2.</span> <span class="toc-text">Node组件</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#部署Etcd集群"><span class="toc-number">2.</span> <span class="toc-text">部署Etcd集群</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#准备工作"><span class="toc-number">2.1.</span> <span class="toc-text">准备工作</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#生成Etcd证书"><span class="toc-number">2.2.</span> <span class="toc-text">生成Etcd证书</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#安装Etcd"><span class="toc-number">2.3.</span> <span class="toc-text">安装Etcd</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#启动Etcd集群"><span class="toc-number">2.4.</span> <span class="toc-text">启动Etcd集群</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#在Node节点安装Docker"><span class="toc-number">3.</span> <span class="toc-text">在Node节点安装Docker</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#部署Flannel网络"><span class="toc-number">4.</span> <span class="toc-text">部署Flannel网络</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#向etcd-写入集群Pod-网段信息"><span class="toc-number">4.1.</span> <span class="toc-text">向etcd 写入集群Pod 网段信息</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#安装和配置flanneld"><span class="toc-number">4.2.</span> <span class="toc-text">安装和配置flanneld</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#重启flannel和docker"><span class="toc-number">4.3.</span> <span class="toc-text">重启flannel和docker</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#检查配置是否生效"><span class="toc-number">4.4.</span> <span class="toc-text">检查配置是否生效</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#在Master上部署组件"><span class="toc-number">5.</span> <span class="toc-text">在Master上部署组件</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#生成证书"><span class="toc-number">5.1.</span> <span class="toc-text">生成证书</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#部署apiserver组件"><span class="toc-number">5.2.</span> <span class="toc-text">部署apiserver组件</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#部署schduler组件"><span class="toc-number">5.3.</span> <span class="toc-text">部署schduler组件</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#部署controller-manager组件"><span class="toc-number">5.4.</span> <span class="toc-text">部署controller-manager组件</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#检查当前集群状态"><span class="toc-number">5.5.</span> <span class="toc-text">检查当前集群状态</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#配置kube-apiserver高可用"><span class="toc-number">6.</span> <span class="toc-text">配置kube-apiserver高可用</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#开启路由转发"><span class="toc-number">6.1.</span> <span class="toc-text">开启路由转发</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#安装keepalived"><span class="toc-number">6.2.</span> <span class="toc-text">安装keepalived:</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#配置keepalived"><span class="toc-number">6.3.</span> <span class="toc-text">配置keepalived</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#启动并验证keepalived"><span class="toc-number">6.4.</span> <span class="toc-text">启动并验证keepalived</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#注意事项"><span class="toc-number">6.5.</span> <span class="toc-text">注意事项</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#部署Node节点"><span class="toc-number">7.</span> <span class="toc-text">部署Node节点</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#绑定集群角色"><span class="toc-number">7.1.</span> <span class="toc-text">绑定集群角色</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#创建kubeconfig文件"><span class="toc-number">7.2.</span> <span class="toc-text">创建kubeconfig文件</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#部署kubelet组件"><span class="toc-number">7.3.</span> <span class="toc-text">部署kubelet组件</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#在master审批Node加入集群"><span class="toc-number">7.4.</span> <span class="toc-text">在master审批Node加入集群</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#部署kube-proxy组件"><span class="toc-number">7.5.</span> <span class="toc-text">部署kube-proxy组件</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#运行一个测试示例"><span class="toc-number">8.</span> <span class="toc-text">运行一个测试示例</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#安装kubernetes-dashboard"><span class="toc-number">9.</span> <span class="toc-text">安装kubernetes-dashboard</span></a></li></ol></nav></div></aside><main class="main" role="main"><div class="content"><article id="post-k8s-install" class="article article-type-post" itemscope itemtype="http://schema.org/BlogPosting"><div class="article-header"><h1 class="article-title" itemprop="name">高可用源码部署Kubernetes</h1><div class="article-meta"><span class="article-date"><i class="icon icon-calendar-check"></i> <a href="/2018/12/18/k8s-install/" class="article-date"><time datetime="2018-12-18T08:17:28.000Z" itemprop="datePublished">2018-12-18</time></a></span> <span class="article-category"><i class="icon icon-folder"></i> <a class="article-category-link" href="/categories/K8s/">K8s</a>►<a class="article-category-link" href="/categories/K8s/Docker/">Docker</a></span> <span class="article-tag"><i class="icon icon-tags"></i> <a class="article-tag-link" href="/tags/Docker/">Docker</a>, <a class="article-tag-link" href="/tags/K8s/">K8s</a></span> <span class="article-read hidden-xs"><i class="icon icon-eye-fill" aria-hidden="true"></i> <span id="busuanzi_container_page_pv"><span id="busuanzi_value_page_pv">0</span></span></span> <span class="post-comment"><i class="icon icon-comment"></i> <a href="/2018/12/18/k8s-install/#comments" class="article-comment-link">评论</a></span> <span class="post-wordcount hidden-xs" itemprop="wordCount">字数统计: 6.1k(字)</span> <span class="post-readcount hidden-xs" itemprop="timeRequired">阅读时长: 32(分)</span></div></div><div class="article-entry marked-body" itemprop="articleBody"><table><thead><tr><th style="text-align:left">角色</th><th style="text-align:left">IP</th><th style="text-align:left">组件</th></tr></thead><tbody><tr><td style="text-align:left">镜像仓库</td><td style="text-align:left">hub.wubolive.com</td><td style="text-align:left">Harbor</td></tr><tr><td style="text-align:left">k8s-master1</td><td style="text-align:left">192.168.0.11</td><td style="text-align:left">kube-apiserver,kube-controller-manage,kube-scheduler,etcd,keepalived</td></tr><tr><td style="text-align:left">k8s-master2</td><td style="text-align:left">192.168.0.12</td><td style="text-align:left">kube-apiserver,kube-controller-manage,kube-scheduler,etcd,keepalived</td></tr><tr><td style="text-align:left">k8s-node1</td><td style="text-align:left">192.168.0.13</td><td style="text-align:left">kubelet,kube-proxy,docker,flannel,etcd</td></tr><tr><td style="text-align:left">k8s-node2</td><td style="text-align:left">192.168.0.14</td><td style="text-align:left">kubelet,kube-proxy,docker,flannel</td></tr><tr><td style="text-align:left">Keeplived</td><td style="text-align:left">192.168.0.10</td><td style="text-align:left">由master1和master2配置的VIP地址</td></tr></tbody></table><h2 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h2><h3 id="Master组件"><a href="#Master组件" class="headerlink" title="Master组件"></a>Master组件</h3><ul><li><strong>kube-apiserver:</strong> Kubernetes API，集群的统一入口，各组件协调者，以RESTful API提供接口服务，所有对象资源的增删改查和监听操作都交给APIServer处理后再提交给Etcd存储。</li><li><strong>kube-controller-manager:</strong> 处理集群中常规后台任务，一个资源对应一个控制器，而ControllerManager就是负责管理这些控制器的。</li><li><strong>kube-scheduler:</strong> 根据调度算法为新创建的Pod选择一个Node节点，可以任意部署,可以部署在同一个节点上,也可以部署在不同的节点上</li></ul><h3 id="Node组件"><a href="#Node组件" class="headerlink" title="Node组件"></a>Node组件</h3><ul><li><strong>kubelet:</strong> kubelet是Master在Node节点上的Agent，管理本机运行容器的生命周期，比如创建容器、Pod挂载数据卷、下载secret、获取容器和节点状态等工作。kubelet将每个Pod转换成一组容器。</li><li><strong>kube-proxy:</strong> 在Node节点上实现Pod网络代理，维护网络规则和四层负载均衡工作。</li><li><strong>docker：</strong> 容器引擎</li><li><strong>etcd:</strong> 分布式键值存储系统。用于保存集群状态数据，比如Pod、Service等对象信息。</li></ul><h2 id="部署Etcd集群"><a href="#部署Etcd集群" class="headerlink" title="部署Etcd集群"></a>部署Etcd集群</h2><h3 id="准备工作"><a href="#准备工作" class="headerlink" title="准备工作"></a>准备工作</h3><p>使用cfssl来生成自签证书，先下载cfssl工具：<br></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-master1 ~]# wget https://pkg.cfssl.org/R1.2/cfssl_linux-amd64</span><br><span class="line">[root@k8s-master1 ~]# wget https://pkg.cfssl.org/R1.2/cfssljson_linux-amd64</span><br><span class="line">[root@k8s-master1 ~]# wget https://pkg.cfssl.org/R1.2/cfssl-certinfo_linux-amd64</span><br><span class="line">[root@k8s-master1 ~]# chmod +x cfssl*</span><br><span class="line">[root@k8s-master1 ~]# mv cfssl_linux-amd64 /usr/local/bin/cfssl</span><br><span class="line">[root@k8s-master1 ~]# mv cfssljson_linux-amd64 /usr/local/bin/cfssljson</span><br><span class="line">[root@k8s-master1 ~]# mv cfssl-certinfo_linux-amd64 /usr/local/bin/cfss-certinfo</span><br></pre></td></tr></table></figure><p></p><h3 id="生成Etcd证书"><a href="#生成Etcd证书" class="headerlink" title="生成Etcd证书"></a>生成Etcd证书</h3><p>编写CA配置文件:<br></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-master1 ~]# touch ca-config.json  ca-csr.json  server-csr.json</span><br><span class="line">[root@k8s-master1 ~]# cat ca-config.json </span><br><span class="line">&#123;</span><br><span class="line">  &quot;signing&quot;: &#123;</span><br><span class="line">    &quot;default&quot;: &#123;</span><br><span class="line">      &quot;expiry&quot;: &quot;87600h&quot;</span><br><span class="line">    &#125;,</span><br><span class="line">    &quot;profiles&quot;: &#123;</span><br><span class="line">      &quot;www&quot;: &#123;</span><br><span class="line">         &quot;expiry&quot;: &quot;87600h&quot;,</span><br><span class="line">         &quot;usages&quot;: [</span><br><span class="line">            &quot;signing&quot;,</span><br><span class="line">            &quot;key encipherment&quot;,</span><br><span class="line">            &quot;server auth&quot;,</span><br><span class="line">            &quot;client auth&quot;</span><br><span class="line">        ]</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>编写证书签名请求配置文件:<br></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-master1 ~]# cat ca-csr.json </span><br><span class="line">&#123;</span><br><span class="line">    &quot;CN&quot;: &quot;etcd CA&quot;,</span><br><span class="line">    &quot;key&quot;: &#123;</span><br><span class="line">        &quot;algo&quot;: &quot;rsa&quot;,</span><br><span class="line">        &quot;size&quot;: 2048</span><br><span class="line">    &#125;,</span><br><span class="line">    &quot;names&quot;: [</span><br><span class="line">        &#123;</span><br><span class="line">            &quot;C&quot;: &quot;CN&quot;,</span><br><span class="line">            &quot;L&quot;: &quot;Beijing&quot;,</span><br><span class="line">            &quot;ST&quot;: &quot;Beijing&quot;</span><br><span class="line">        &#125;</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>编写etcd集群证书配置文件：<br></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-master1 ~]# cat server-csr.json </span><br><span class="line">&#123;</span><br><span class="line">    &quot;CN&quot;: &quot;etcd&quot;,</span><br><span class="line">    &quot;hosts&quot;: [</span><br><span class="line">        &quot;192.168.0.11&quot;,</span><br><span class="line">        &quot;192.168.0.12&quot;,</span><br><span class="line">        &quot;192.168.0.13&quot;,</span><br><span class="line">        &quot;192.168.0.14&quot;</span><br><span class="line">    ],</span><br><span class="line">    &quot;key&quot;: &#123;</span><br><span class="line">        &quot;algo&quot;: &quot;rsa&quot;,</span><br><span class="line">        &quot;size&quot;: 2048</span><br><span class="line">    &#125;,</span><br><span class="line">    &quot;names&quot;: [</span><br><span class="line">        &#123;</span><br><span class="line">            &quot;C&quot;: &quot;CN&quot;,</span><br><span class="line">            &quot;L&quot;: &quot;BeiJing&quot;,</span><br><span class="line">            &quot;ST&quot;: &quot;BeiJing&quot;</span><br><span class="line">        &#125;</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>生成证书和密钥<br></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-master1 ~]# cfssl gencert -initca ca-csr.json | cfssljson -bare ca -</span><br><span class="line">[root@k8s-master1 ~]# cfssl gencert -ca=ca.pem -ca-key=ca-key.pem -config=ca-config.json -profile=www server-csr.json | cfssljson -bare server</span><br><span class="line">[root@k8s-master1 ~]# ls *.pem</span><br><span class="line">ca-key.pem  ca.pem  server-key.pem  server.pem</span><br><span class="line"># 生成证书时注意输出信息,如果配置文件格式有问题就会报错</span><br></pre></td></tr></table></figure><p></p><h3 id="安装Etcd"><a href="#安装Etcd" class="headerlink" title="安装Etcd"></a>安装Etcd</h3><p>二进制包下载地址：<a href="https://github.com/coreos/etcd/releases/tag/v3.2.12" target="_blank" rel="noopener">https://github.com/coreos/etcd/releases/tag/v3.2.12</a><br>以下步骤在规划的四个节点操作是一样的，除了etcd配置文件中的服务器IP和ETCD_NAME。<br>下载并解压二进制包<br></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-master1 ~]# wget https://github.com/etcd-io/etcd/releases/download/v3.2.12/etcd-v3.2.12-linux-amd64.tar.gz</span><br><span class="line">[root@k8s-master1 ~]# mkdir -p /home/etcd/&#123;bin,conf,data,ssl&#125;</span><br><span class="line">[root@k8s-master1 ~]# tar zxf etcd-v3.2.12-linux-amd64.tar.gz</span><br><span class="line">[root@k8s-master1 ~]# mv etcd-v3.2.12-linux-amd64/&#123;etcd,etcdctl&#125; /home/etcd/bin/</span><br><span class="line">[root@k8s-master1 ~]# ln -s /home/etcd/bin/etcd /usr/local/bin/etcd</span><br><span class="line">[root@k8s-master1 ~]# ln -s /home/etcd/bin/etcdctl /usr/local/bin/etcdctl</span><br></pre></td></tr></table></figure><p></p><p>创建etcd配置文件 (注意ip地址及节点名称)。<br></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-master1 ~]# vim /home/etcd/conf/etcd.conf</span><br><span class="line">#[Member]</span><br><span class="line">ETCD_NAME=&quot;etcd01&quot;</span><br><span class="line">ETCD_DATA_DIR=&quot;/home/etcd/data&quot;</span><br><span class="line">ETCD_LISTEN_PEER_URLS=&quot;https://192.168.0.11:2380&quot;</span><br><span class="line">ETCD_LISTEN_CLIENT_URLS=&quot;https://192.168.0.11:2379&quot;</span><br><span class="line"></span><br><span class="line">#[Clustering]</span><br><span class="line">ETCD_INITIAL_ADVERTISE_PEER_URLS=&quot;https://192.168.0.11:2380&quot;</span><br><span class="line">ETCD_ADVERTISE_CLIENT_URLS=&quot;https://192.168.0.11:2379&quot;</span><br><span class="line">ETCD_INITIAL_CLUSTER=&quot;etcd01=https://192.168.0.11:2380,etcd02=https://192.168.0.12:2380,etcd03=https://192.168.0.13:2380,etcd04=https://192.168.0.14:2380&quot;</span><br><span class="line">ETCD_INITIAL_CLUSTER_TOKEN=&quot;etcd-cluster&quot;</span><br><span class="line">ETCD_INITIAL_CLUSTER_STATE=&quot;new&quot;</span><br></pre></td></tr></table></figure><p></p><p>说明：</p><ul><li><code>ETCD_NAME</code> 节点名称</li><li><code>ETCD_DATA_DIR</code> 数据目录</li><li><code>ETCD_LISTEN_PEER_URLS</code> 集群通信监听地址</li><li><code>ETCD_LISTEN_CLIENT_URLS</code> 客户端访问监听地址</li><li><code>ETCD_INITIAL_ADVERTISE_PEER_URLS</code> 集群通告地址</li><li><code>ETCD_ADVERTISE_CLIENT_URLS</code> 客户端通告地址</li><li><code>ETCD_INITIAL_CLUSTER</code> 集群节点地址</li><li><code>ETCD_INITIAL_CLUSTER_TOKEN</code> 集群Token</li><li><code>ETCD_INITIAL_CLUSTER_STATE</code> 加入集群的当前状态，new是新集群，existing表示加入已有集群</li></ul><p>systemctl管理etcd：<br></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-master1 ~]# vim /usr/lib/systemd/system/etcd.service </span><br><span class="line">[Unit]</span><br><span class="line">Description=Etcd Server</span><br><span class="line">After=network.target</span><br><span class="line">After=network-online.target</span><br><span class="line">Wants=network-online.target</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">Type=notify </span><br><span class="line">EnvironmentFile=/home/etcd/conf/etcd.conf</span><br><span class="line">ExecStart=/home/etcd/bin/etcd \</span><br><span class="line">--name=$&#123;ETCD_NAME&#125; \</span><br><span class="line">--data-dir=$&#123;ETCD_DATA_DIR&#125; \</span><br><span class="line">--listen-peer-urls=$&#123;ETCD_LISTEN_PEER_URLS&#125; \</span><br><span class="line">--listen-client-urls=$&#123;ETCD_LISTEN_CLIENT_URLS&#125;,http://127.0.0.1:2379 \</span><br><span class="line">--advertise-client-urls=$&#123;ETCD_ADVERTISE_CLIENT_URLS&#125; \</span><br><span class="line">--initial-advertise-peer-urls=$&#123;ETCD_INITIAL_ADVERTISE_PEER_URLS&#125; \</span><br><span class="line">--initial-cluster=$&#123;ETCD_INITIAL_CLUSTER&#125; \</span><br><span class="line">--initial-cluster-token=$&#123;ETCD_INITIAL_CLUSTER_TOKEN&#125; \</span><br><span class="line">--initial-cluster-state=new \</span><br><span class="line">--cert-file=/home/etcd/ssl/server.pem \</span><br><span class="line">--key-file=/home/etcd/ssl/server-key.pem \</span><br><span class="line">--peer-cert-file=/home/etcd/ssl/server.pem \</span><br><span class="line">--peer-key-file=/home/etcd/ssl/server-key.pem \</span><br><span class="line">--trusted-ca-file=/home/etcd/ssl/ca.pem \</span><br><span class="line">--peer-trusted-ca-file=/home/etcd/ssl/ca.pem</span><br><span class="line">Restart=on-failure</span><br><span class="line">LimitNOFILE=65536</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br></pre></td></tr></table></figure><p></p><p>将生成的证书文件拷贝到配置文件中的位置。<br></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-master1 ~]# cp ca*.pem server*.pem /home/etcd/ssl/</span><br></pre></td></tr></table></figure><p></p><h3 id="启动Etcd集群"><a href="#启动Etcd集群" class="headerlink" title="启动Etcd集群"></a>启动Etcd集群</h3><p>在各节点中运行<br></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-master1 ~]# systemctl start etcd</span><br><span class="line">[root@k8s-master1 ~]# systemctl enable etcd</span><br></pre></td></tr></table></figure><p></p><p>启动成功后，检查Etcd集群状态：<br></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-master1 ~]# etcdctl --ca-file=/home/etcd/ssl/ca.pem --cert-file=/home/etcd/ssl/server.pem --key-file=/home/etcd/ssl/server-key.pem --endpoints=&quot;https://192.168.0.11:2379,https://192.168.0.12:2379,https://192.168.0.13:2379,https://192.168.0.14:2379&quot; cluster-health</span><br><span class="line">member b8fffb7f5b2f26e is healthy: got healthy result from https://192.168.0.12:2379</span><br><span class="line">member cb18584c4f4dbfc is healthy: got healthy result from https://192.168.0.11:2379</span><br><span class="line">member 1678ac552db73f86 is healthy: got healthy result from https://192.168.0.14:2379</span><br><span class="line">member 32cf7f46292d6a20 is healthy: got healthy result from https://192.168.0.13:2379</span><br><span class="line">cluster is healthy</span><br></pre></td></tr></table></figure><p></p><p>上述信息表上部署成功，如果有问题可执行journalctl -u etcd查看报错信息。</p><hr><h2 id="在Node节点安装Docker"><a href="#在Node节点安装Docker" class="headerlink" title="在Node节点安装Docker"></a>在Node节点安装Docker</h2><p>从国内源下载并安装docker-ce<br></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-node1 ~]# yum install -y yum-utils device-mapper-persistent-data lvm2</span><br><span class="line">[root@k8s-node1 ~]# yum-config-manager --add-repo https://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo</span><br><span class="line">[root@k8s-node1 ~]# yum install docker-ce -y</span><br></pre></td></tr></table></figure><p></p><p>配置docker国内镜像源并启动<br></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-node1 ~]# curl -sSL https://get.daocloud.io/daotools/set_mirror.sh | sh -s http://bc437cce.m.daocloud.io</span><br><span class="line">[root@k8s-node1 ~]# systemctl start docker</span><br><span class="line">[root@k8s-node1 ~]# systemctl enable docker</span><br></pre></td></tr></table></figure><p></p><hr><h2 id="部署Flannel网络"><a href="#部署Flannel网络" class="headerlink" title="部署Flannel网络"></a>部署Flannel网络</h2><h3 id="向etcd-写入集群Pod-网段信息"><a href="#向etcd-写入集群Pod-网段信息" class="headerlink" title="向etcd 写入集群Pod 网段信息"></a>向etcd 写入集群Pod 网段信息</h3><p>该步骤只需在第一次部署Flannel 网络时执行，后续在其他节点上部署Flanneld 时无需再写入该信息<br></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-master1 ~]# cd /home/etcd/ssl/</span><br><span class="line">[root@k8s-master1 ssl]# /home/etcd/bin/etcdctl \</span><br><span class="line">--ca-file=ca.pem --cert-file=server.pem --key-file=server-key.pem \</span><br><span class="line">--endpoints=&quot;https://192.168.0.11:2379,https://192.168.0.12:2379,https://192.168.0.13:2379,https://192.168.0.14:2379&quot; \</span><br><span class="line">set /coreos.com/network/config  &apos;&#123; &quot;Network&quot;: &quot;172.30.0.0/16&quot;, &quot;Backend&quot;: &#123;&quot;Type&quot;: &quot;vxlan&quot;&#125;&#125;&apos;</span><br><span class="line">#返回信息：</span><br><span class="line">&#123; &quot;Network&quot;: &quot;172.30.0.0/16&quot;, &quot;Backend&quot;: &#123;&quot;Type&quot;: &quot;vxlan&quot;&#125;&#125;</span><br></pre></td></tr></table></figure><p></p><h3 id="安装和配置flanneld"><a href="#安装和配置flanneld" class="headerlink" title="安装和配置flanneld"></a>安装和配置flanneld</h3><p>(node节点)下载二进制包:<br></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-node1 ~]# wget https://github.com/coreos/flannel/releases/download/v0.10.0/flannel-v0.10.0-linux-amd64.tar.gz</span><br><span class="line">[root@k8s-node1 ~]# tar zxf flannel-v0.10.0-linux-amd64.tar.gz </span><br><span class="line">[root@k8s-node1 ~]# mkdir /home/kubernetes/&#123;conf,bin&#125; -p</span><br><span class="line">[root@k8s-node1 ~]# mv flanneld mk-docker-opts.sh /home/kubernetes/bin/</span><br></pre></td></tr></table></figure><p></p><p>配置Flannel:<br></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-node1 ~]# vim /home/kubernetes/conf/flanneld.conf</span><br><span class="line">FLANNEL_OPTIONS=&quot;--etcd-endpoints=https://192.168.0.11:2379,https://192.168.0.12:2379,https://192.168.0.13:2379,https://192.168.0.14:2379 -etcd-cafile=/home/etcd/ssl/ca.pem -etcd-certfile=/home/etcd/ssl/server.pem -etcd-keyfile=/home/etcd/ssl/server-key.pem&quot;</span><br></pre></td></tr></table></figure><p></p><p>配置systemcatl管理flanneld<br></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-node1 ~]# vim /usr/lib/systemd/system/flanneld.service</span><br><span class="line">[Unit]</span><br><span class="line">Description=Flanneld overlay address etcd agent</span><br><span class="line">After=network-online.target network.target</span><br><span class="line">Before=docker.service</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">Type=notify</span><br><span class="line">EnvironmentFile=/home/kubernetes/conf/flanneld.conf</span><br><span class="line">ExecStart=/home/kubernetes/bin/flanneld --ip-masq $FLANNEL_OPTIONS</span><br><span class="line">ExecStartPost=/home/kubernetes/bin/mk-docker-opts.sh -k DOCKER_NETWORK_OPTIONS -d /run/flannel/subnet.env</span><br><span class="line">Restart=on-failure</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br></pre></td></tr></table></figure><p></p><p>更改Docker配置指定子网段<br></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-node1 ~]# vim /usr/lib/systemd/system/docker.service </span><br><span class="line">[Unit]</span><br><span class="line">Description=Docker Application Container Engine</span><br><span class="line">Documentation=https://docs.docker.com</span><br><span class="line">After=network-online.target firewalld.service</span><br><span class="line">Wants=network-online.target</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">Type=notify</span><br><span class="line">EnvironmentFile=/run/flannel/subnet.env</span><br><span class="line">ExecStart=/usr/bin/dockerd $DOCKER_NETWORK_OPTIONS</span><br><span class="line">ExecReload=/bin/kill -s HUP $MAINPID</span><br><span class="line">LimitNOFILE=infinity</span><br><span class="line">LimitNPROC=infinity</span><br><span class="line">LimitCORE=infinity</span><br><span class="line">TimeoutStartSec=0</span><br><span class="line">Delegate=yes</span><br><span class="line">KillMode=process</span><br><span class="line">Restart=on-failure</span><br><span class="line">StartLimitBurst=3</span><br><span class="line">StartLimitInterval=60s</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br></pre></td></tr></table></figure><p></p><h3 id="重启flannel和docker"><a href="#重启flannel和docker" class="headerlink" title="重启flannel和docker"></a>重启flannel和docker</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-node1 ~]# systemctl daemon-reload</span><br><span class="line">[root@k8s-node1 ~]# systemctl start flanneld</span><br><span class="line">[root@k8s-node1 ~]# systemctl enable flanneld</span><br><span class="line">[root@k8s-node1 ~]# systemctl restart docker</span><br></pre></td></tr></table></figure><h3 id="检查配置是否生效"><a href="#检查配置是否生效" class="headerlink" title="检查配置是否生效"></a>检查配置是否生效</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"># node1</span><br><span class="line">[root@k8s-node1 ~]# ps -ef | grep docker</span><br><span class="line">root      27850      1  0 02:25 ?        00:00:00 /usr/bin/dockerd --bip=172.30.35.1/24 --ip-masq=false --mtu=1450</span><br><span class="line">4: docker0: &lt;NO-CARRIER,BROADCAST,MULTICAST,UP&gt; mtu 1500 qdisc noqueue state DOWN </span><br><span class="line">    link/ether 02:42:bc:2c:a1:96 brd ff:ff:ff:ff:ff:ff</span><br><span class="line">    inet 172.30.35.1/24 brd 172.30.35.255 scope global docker0</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">5: flannel.1: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1450 qdisc noqueue state UNKNOWN </span><br><span class="line">    link/ether f6:a6:91:34:86:fe brd ff:ff:ff:ff:ff:ff</span><br><span class="line">    inet 172.30.35.0/32 scope global flannel.1</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line"></span><br><span class="line"># node2</span><br><span class="line">[root@k8s-node2 ~]# ps -ef | grep docker</span><br><span class="line">root      27215      1  0 02:24 ?        00:00:00 /usr/bin/dockerd --bip=172.30.16.1/24 --ip-masq=false --mtu=1450</span><br><span class="line">4: docker0: &lt;NO-CARRIER,BROADCAST,MULTICAST,UP&gt; mtu 1500 qdisc noqueue state DOWN </span><br><span class="line">    link/ether 02:42:de:a7:53:8f brd ff:ff:ff:ff:ff:ff</span><br><span class="line">    inet 172.30.16.1/24 brd 172.30.16.255 scope global docker0</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">5: flannel.1: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1450 qdisc noqueue state UNKNOWN </span><br><span class="line">    link/ether 72:a3:0f:f4:a7:0e brd ff:ff:ff:ff:ff:ff</span><br><span class="line">    inet 172.30.16.0/32 scope global flannel.1</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br></pre></td></tr></table></figure><p>请确docker0与flannel.1在同一网段，然后测试两台主机的docker0通信<br></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"># 从node1上ping node2的docker0IP</span><br><span class="line">[root@k8s-node1 ~]# ping 172.30.16.1</span><br><span class="line">PING 172.30.16.1 (172.30.16.1) 56(84) bytes of data.</span><br><span class="line">64 bytes from 172.30.16.1: icmp_seq=1 ttl=64 time=0.459 ms</span><br><span class="line">64 bytes from 172.30.16.1: icmp_seq=2 ttl=64 time=1.06 ms</span><br></pre></td></tr></table></figure><p></p><p>能ping通说明flannel部署成功</p><hr><h2 id="在Master上部署组件"><a href="#在Master上部署组件" class="headerlink" title="在Master上部署组件"></a>在Master上部署组件</h2><p>在安装完上面etcd,flannel,docker后接下来开始安装master组件。</p><h3 id="生成证书"><a href="#生成证书" class="headerlink" title="生成证书"></a>生成证书</h3><p>创建CA证书<br></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-master1 ~]# mkdir -p /home/kubernetes/&#123;ssl,conf,bin&#125;</span><br><span class="line">[root@k8s-master1 ~]# cd /home/kubernetes/ssl/</span><br><span class="line">[root@k8s-master1 ssl]# vim ca-config.json</span><br><span class="line">&#123;</span><br><span class="line">  &quot;signing&quot;: &#123;</span><br><span class="line">    &quot;default&quot;: &#123;</span><br><span class="line">      &quot;expiry&quot;: &quot;87600h&quot;</span><br><span class="line">    &#125;,</span><br><span class="line">    &quot;profiles&quot;: &#123;</span><br><span class="line">      &quot;kubernetes&quot;: &#123;</span><br><span class="line">         &quot;expiry&quot;: &quot;87600h&quot;,</span><br><span class="line">         &quot;usages&quot;: [</span><br><span class="line">            &quot;signing&quot;,</span><br><span class="line">            &quot;key encipherment&quot;,</span><br><span class="line">            &quot;server auth&quot;,</span><br><span class="line">            &quot;client auth&quot;</span><br><span class="line">        ]</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">[root@k8s-master1 ssl]# vim ca-csr.json</span><br><span class="line">&#123;</span><br><span class="line">    &quot;CN&quot;: &quot;kubernetes&quot;,</span><br><span class="line">    &quot;key&quot;: &#123;</span><br><span class="line">        &quot;algo&quot;: &quot;rsa&quot;,</span><br><span class="line">        &quot;size&quot;: 2048</span><br><span class="line">    &#125;,</span><br><span class="line">    &quot;names&quot;: [</span><br><span class="line">        &#123;</span><br><span class="line">            &quot;C&quot;: &quot;CN&quot;,</span><br><span class="line">            &quot;L&quot;: &quot;Beijing&quot;,</span><br><span class="line">            &quot;ST&quot;: &quot;Beijing&quot;,</span><br><span class="line">            &quot;O&quot;: &quot;k8s&quot;,</span><br><span class="line">            &quot;OU&quot;: &quot;System&quot;</span><br><span class="line">        &#125;</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br><span class="line">[root@k8s-master1 ssl]# cfssl gencert -initca ca-csr.json | cfssljson -bare ca -</span><br></pre></td></tr></table></figure><p></p><p>生成apiserver证书<br></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-master1 ssl]# vim server-csr.json</span><br><span class="line">&#123;</span><br><span class="line">    &quot;CN&quot;: &quot;kubernetes&quot;,</span><br><span class="line">    &quot;hosts&quot;: [</span><br><span class="line">        &quot;127.0.0.1&quot;,</span><br><span class="line">        &quot;192.168.0.10&quot;,</span><br><span class="line">        &quot;192.168.0.11&quot;,</span><br><span class="line">        &quot;192.168.0.12&quot;,</span><br><span class="line">        &quot;192.168.0.13&quot;,</span><br><span class="line">        &quot;192.168.0.14&quot;,</span><br><span class="line">        &quot;kubernetes&quot;,</span><br><span class="line">        &quot;kubernetes.default&quot;,</span><br><span class="line">        &quot;kubernetes.default.svc&quot;,</span><br><span class="line">        &quot;kubernetes.default.svc.cluster&quot;,</span><br><span class="line">        &quot;kubernetes.default.svc.cluster.local&quot;</span><br><span class="line">    ],</span><br><span class="line">    &quot;key&quot;: &#123;</span><br><span class="line">        &quot;algo&quot;: &quot;rsa&quot;,</span><br><span class="line">        &quot;size&quot;: 2048</span><br><span class="line">    &#125;,</span><br><span class="line">    &quot;names&quot;: [</span><br><span class="line">        &#123;</span><br><span class="line">            &quot;C&quot;: &quot;CN&quot;,</span><br><span class="line">            &quot;L&quot;: &quot;BeiJing&quot;,</span><br><span class="line">            &quot;ST&quot;: &quot;BeiJing&quot;,</span><br><span class="line">            &quot;O&quot;: &quot;k8s&quot;,</span><br><span class="line">            &quot;OU&quot;: &quot;System&quot;</span><br><span class="line">        &#125;</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br><span class="line">[root@k8s-master1 ssl]# cfssl gencert -ca=ca.pem -ca-key=ca-key.pem -config=ca-config.json -profile=kubernetes server-csr.json | cfssljson -bare server</span><br></pre></td></tr></table></figure><p></p><p>生成kube-proxy证书:<br></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-master1 ssl]# vim kube-proxy-csr.json</span><br><span class="line">&#123;</span><br><span class="line">  &quot;CN&quot;: &quot;system:kube-proxy&quot;,</span><br><span class="line">  &quot;hosts&quot;: [],</span><br><span class="line">  &quot;key&quot;: &#123;</span><br><span class="line">    &quot;algo&quot;: &quot;rsa&quot;,</span><br><span class="line">    &quot;size&quot;: 2048</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;names&quot;: [</span><br><span class="line">    &#123;</span><br><span class="line">      &quot;C&quot;: &quot;CN&quot;,</span><br><span class="line">      &quot;L&quot;: &quot;BeiJing&quot;,</span><br><span class="line">      &quot;ST&quot;: &quot;BeiJing&quot;,</span><br><span class="line">      &quot;O&quot;: &quot;k8s&quot;,</span><br><span class="line">      &quot;OU&quot;: &quot;System&quot;</span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br><span class="line">[root@k8s-master1 ssl]# cfssl gencert -ca=ca.pem -ca-key=ca-key.pem -config=ca-config.json -profile=kubernetes kube-proxy-csr.json | cfssljson -bare kube-proxy</span><br></pre></td></tr></table></figure><p></p><p>完成如上操作将会生成以下证书文件:<br></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-master1 ssl]# ls *.pem</span><br><span class="line">ca-key.pem  ca.pem  kube-proxy-key.pem  kube-proxy.pem  server-key.pem  server.pem</span><br></pre></td></tr></table></figure><p></p><h3 id="部署apiserver组件"><a href="#部署apiserver组件" class="headerlink" title="部署apiserver组件"></a>部署apiserver组件</h3><p>到gitlab上下载二进制包 <a href="https://github.com/kubernetes/kubernetes/blob/master/CHANGELOG-1.11.md" target="_blank" rel="noopener">https://github.com/kubernetes/kubernetes/blob/master/CHANGELOG-1.11.md</a><br></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-master1 ~]# wget https://dl.k8s.io/v1.11.5/kubernetes-server-linux-amd64.tar.gz</span><br><span class="line">[root@k8s-master1 ~]# tar zxf kubernetes-server-linux-amd64.tar.gz</span><br><span class="line">[root@k8s-master1 ~]# cd kubernetes/server/bin/</span><br><span class="line">[root@k8s-master1 bin]# cp kube-apiserver kube-scheduler kube-controller-manager kubectl /home/kubernetes/bin/</span><br></pre></td></tr></table></figure><p></p><p>生成Token并创建token文件<br></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-master1 ~]# head -c 16 /dev/urandom | od -An -t x | tr -d &apos; &apos;</span><br><span class="line">29cd86c2fd73035417e38c53bc8f12d9</span><br><span class="line">[root@k8s-master1 ~]# vim /home/kubernetes/conf/token.csv              </span><br><span class="line">29cd86c2fd73035417e38c53bc8f12d9,kubelet-bootstrap,10001,&quot;system:kubelet-bootstrap&quot;</span><br></pre></td></tr></table></figure><p></p><p>创建apiserver配置文件<br></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-master1 ~]# vim /home/kubernetes/conf/kube-apiserver</span><br><span class="line">KUBE_APISERVER_OPTS=&quot;--logtostderr=true \</span><br><span class="line">--v=4 \</span><br><span class="line">--etcd-servers=https://192.168.0.11:2379,https://192.168.0.12:2379,https://192.168.0.13:2379,https://192.168.0.14:2379 \</span><br><span class="line">--bind-address=0.0.0.0 \</span><br><span class="line">--insecure-bind-address=0.0.0.0 \</span><br><span class="line">--secure-port=6443 \</span><br><span class="line">--advertise-address=192.168.0.11 \</span><br><span class="line">--allow-privileged=true \</span><br><span class="line">--service-cluster-ip-range=192.168.0.0/24 \</span><br><span class="line">--enable-admission-plugins=NamespaceLifecycle,LimitRanger,SecurityContextDeny,ServiceAccount,ResourceQuota,NodeRestriction \</span><br><span class="line">--authorization-mode=RBAC,Node \</span><br><span class="line">--enable-bootstrap-token-auth \</span><br><span class="line">--token-auth-file=/home/kubernetes/conf/token.csv \</span><br><span class="line">--service-node-port-range=30000-50000 \</span><br><span class="line">--tls-cert-file=/home/kubernetes/ssl/server.pem  \</span><br><span class="line">--tls-private-key-file=/home/kubernetes/ssl/server-key.pem \</span><br><span class="line">--client-ca-file=/home/kubernetes/ssl/ca.pem \</span><br><span class="line">--service-account-key-file=/home/kubernetes/ssl/ca-key.pem \</span><br><span class="line">--etcd-cafile=/home/etcd/ssl/ca.pem \</span><br><span class="line">--etcd-certfile=/home/etcd/ssl/server.pem \</span><br><span class="line">--etcd-keyfile=/home/etcd/ssl/server-key.pem&quot;</span><br></pre></td></tr></table></figure><p></p><p>参数说明：</p><ul><li><code>--logtostderr</code> 启用日志</li><li><code>---v</code> 日志等级</li><li><code>--etcd-servers</code> etcd集群地址</li><li><code>--bind-address</code> 监听地址</li><li><code>--secure-port</code> https安全端口</li><li><code>--advertise-address</code> 集群通告地址</li><li><code>--allow-privileged</code> 启用授权</li><li><code>--service-cluster-ip-range</code> Service虚拟IP地址段</li><li><code>--enable-admission-plugins</code> 准入控制模块</li><li><code>--authorization-mode</code> 认证授权，启用RBAC授权和节点自管理</li><li><code>--enable-bootstrap-token-auth</code> 启用TLS bootstrap功能，后面会讲到</li><li><code>--token-auth-file</code> token文件</li><li><code>--service-node-port-range</code> Service Node类型默认分配端口范围</li></ul><p>使用systemctl管理apiserver<br></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-master1 ~]# vim /usr/lib/systemd/system/kube-apiserver.service</span><br><span class="line">[Unit]</span><br><span class="line">Description=Kubernetes API Server</span><br><span class="line">Documentation=https://github.com/kubernetes/kubernetes</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">EnvironmentFile=-/home/kubernetes/conf/kube-apiserver</span><br><span class="line">ExecStart=/home/kubernetes/bin/kube-apiserver $KUBE_APISERVER_OPTS</span><br><span class="line">Restart=on-failure</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br></pre></td></tr></table></figure><p></p><p>启动kube-apiserver<br></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-master1 ~]# systemctl start kube-apiserver</span><br><span class="line">[root@k8s-master1 ~]# systemctl enable kube-apiserver</span><br></pre></td></tr></table></figure><p></p><h3 id="部署schduler组件"><a href="#部署schduler组件" class="headerlink" title="部署schduler组件"></a>部署schduler组件</h3><p>创建schduler配置文件<br></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-master1 ~]# vim /home/kubernetes/conf/kube-scheduler</span><br><span class="line">KUBE_SCHEDULER_OPTS=&quot;--logtostderr=true \</span><br><span class="line">--v=4 \</span><br><span class="line">--master=127.0.0.1:8080 \</span><br><span class="line">--leader-elect&quot;</span><br></pre></td></tr></table></figure><p></p><p>参数说明:</p><ul><li><code>--master</code> 连接本地apiserver</li><li><code>--leader-elect</code> 当该组件启动多个时，自动选举（HA）</li></ul><p>使用systemd管理schduler组件<br></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-master1 ~]# vim /usr/lib/systemd/system/kube-scheduler.service </span><br><span class="line">[Unit]</span><br><span class="line">Description=Kubernetes Scheduler</span><br><span class="line">Documentation=https://github.com/kubernetes/kubernetes</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">EnvironmentFile=-/home/kubernetes/conf/kube-scheduler</span><br><span class="line">ExecStart=/home/kubernetes/bin/kube-scheduler $KUBE_SCHEDULER_OPTS</span><br><span class="line">Restart=on-failure</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br></pre></td></tr></table></figure><p></p><p>启动kube-scheduler<br></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-master1 ~]# systemctl enable kube-scheduler </span><br><span class="line">[root@k8s-master1 ~]# systemctl start kube-scheduler</span><br></pre></td></tr></table></figure><p></p><h3 id="部署controller-manager组件"><a href="#部署controller-manager组件" class="headerlink" title="部署controller-manager组件"></a>部署controller-manager组件</h3><p>创建controller-manager配置文件：<br></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-master1 ~]# vim /home/kubernetes/conf/kube-controller-manager </span><br><span class="line">KUBE_CONTROLLER_MANAGER_OPTS=&quot;--logtostderr=true \</span><br><span class="line">--v=4 \</span><br><span class="line">--master=127.0.0.1:8080 \</span><br><span class="line">--leader-elect=true \</span><br><span class="line">--address=127.0.0.1 \</span><br><span class="line">--service-cluster-ip-range=192.168.0.0/24 \</span><br><span class="line">--cluster-name=kubernetes \</span><br><span class="line">--cluster-signing-cert-file=/home/kubernetes/ssl/ca.pem \</span><br><span class="line">--cluster-signing-key-file=/home/kubernetes/ssl/ca-key.pem  \</span><br><span class="line">--root-ca-file=/home/kubernetes/ssl/ca.pem \</span><br><span class="line">--service-account-private-key-file=/home/kubernetes/ssl/ca-key.pem&quot;</span><br></pre></td></tr></table></figure><p></p><p>使用systemctl管理controller-manager组件<br></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-master1 ~]# vim /usr/lib/systemd/system/kube-controller-manager.service</span><br><span class="line">[Unit]</span><br><span class="line">Description=Kubernetes Controller Manager</span><br><span class="line">Documentation=https://github.com/kubernetes/kubernetes</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">EnvironmentFile=-/home/kubernetes/conf/kube-controller-manager</span><br><span class="line">ExecStart=/home/kubernetes/bin/kube-controller-manager $KUBE_CONTROLLER_MANAGER_OPTS</span><br><span class="line">Restart=on-failure</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br></pre></td></tr></table></figure><p></p><p>启动controller-manager<br></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-master1 ~]# systemctl start kube-controller-manager</span><br><span class="line">[root@k8s-master1 ~]# systemctl enable kube-controller-manager</span><br></pre></td></tr></table></figure><p></p><h3 id="检查当前集群状态"><a href="#检查当前集群状态" class="headerlink" title="检查当前集群状态"></a>检查当前集群状态</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"># 配置kubectl命令环境变量</span><br><span class="line">[root@k8s-master1 ~]# vim /etc/profile</span><br><span class="line">K8S_HOME=/home/kubernetes</span><br><span class="line">ETCD_HOME=/home/etcd</span><br><span class="line">export PATH=$PATH:$K8S_HOME/bin:$ETCD_HOME/bin</span><br><span class="line">[root@k8s-master1 ~]# source /etc/profile</span><br><span class="line"></span><br><span class="line"># 查看组件状态</span><br><span class="line">[root@k8s-master1 ~]# kubectl get cs</span><br><span class="line">NAME                 STATUS    MESSAGE              ERROR</span><br><span class="line">controller-manager   Healthy   ok                   </span><br><span class="line">scheduler            Healthy   ok                   </span><br><span class="line">etcd-2               Healthy   &#123;&quot;health&quot;: &quot;true&quot;&#125;   </span><br><span class="line">etcd-1               Healthy   &#123;&quot;health&quot;: &quot;true&quot;&#125;   </span><br><span class="line">etcd-3               Healthy   &#123;&quot;health&quot;: &quot;true&quot;&#125;   </span><br><span class="line">etcd-0               Healthy   &#123;&quot;health&quot;: &quot;true&quot;&#125;</span><br></pre></td></tr></table></figure><p>输出如上信息，说明所有组件都正常，然后在master2上也部署一遍</p><hr><h2 id="配置kube-apiserver高可用"><a href="#配置kube-apiserver高可用" class="headerlink" title="配置kube-apiserver高可用"></a>配置kube-apiserver高可用</h2><p>按照上面的方式在master1与master2机器上安装<code>kube-apiserver</code>、<code>kube-controller-manager</code>、<code>kube-scheduler</code>，但是<code>kube-apiserver</code>还不是高可用的，如果master1 这个节点down 掉了，那么我们api就不能正常提供服务了。这里我们可以使用两种方法来实现高可用<br><strong>方式1：使用阿里云SLB</strong><br>这种方式实际上是最省心的，在阿里云上建一个内网的SLB，将master1 与master2 添加到SLB 机器组中，转发8080(http)和6443(https)端口即可<br><strong>方式2：使用keepalived</strong><br>KeepAlived 是一个高可用方案，通过 VIP（即虚拟 IP）和心跳检测来实现高可用</p><h3 id="开启路由转发"><a href="#开启路由转发" class="headerlink" title="开启路由转发"></a>开启路由转发</h3><p>master1与master2 节点都需要安装keepalived,这里我们定义虚拟IP为：192.168.0.10<br></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-master1 ~]# vi /etc/sysctl.conf</span><br><span class="line"># 添加以下内容</span><br><span class="line">net.ipv4.ip_forward = 1</span><br><span class="line">net.ipv4.ip_nonlocal_bind = 1</span><br><span class="line"></span><br><span class="line"># 验证并生效</span><br><span class="line">[root@k8s-master1 ~]# sysctl -p</span><br><span class="line"># 验证是否生效</span><br><span class="line">[root@k8s-master1 ~]# cat /proc/sys/net/ipv4/ip_forward</span><br><span class="line">1</span><br></pre></td></tr></table></figure><p></p><h3 id="安装keepalived"><a href="#安装keepalived" class="headerlink" title="安装keepalived:"></a>安装keepalived:</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-master1 ~]# yum install -y keepalived</span><br></pre></td></tr></table></figure><h3 id="配置keepalived"><a href="#配置keepalived" class="headerlink" title="配置keepalived"></a>配置keepalived</h3><p>我们这里将master1 设置为Master，master2 设置为Backup，修改配置：<br></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-master1 ~]# vim /etc/keepalived/keepalived.conf</span><br><span class="line">! Configuration File for keepalived</span><br><span class="line"></span><br><span class="line">global_defs &#123;</span><br><span class="line">   notification_email &#123;</span><br><span class="line">   &#125;</span><br><span class="line">   router_id kube_api</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">vrrp_script check_k8s-api &#123;</span><br><span class="line">    # 自身状态检测</span><br><span class="line">    script &quot;killall -0 kube-apiserver&quot;</span><br><span class="line">    interval 3</span><br><span class="line">    weight 5</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">vrrp_instance k8s-api-vip &#123;</span><br><span class="line">    # 使用单播通信，默认是组播通信</span><br><span class="line">    unicast_src_ip 192.168.0.11</span><br><span class="line">    unicast_peer &#123;</span><br><span class="line">        192.168.0.12</span><br><span class="line">    &#125;</span><br><span class="line">    # 初始化状态</span><br><span class="line">    state MASTER</span><br><span class="line">    # 虚拟ip 绑定的网卡 （这里根据你自己的实际情况选择网卡）</span><br><span class="line">    interface eno16777736</span><br><span class="line">    # 此ID 要与Backup 配置一致</span><br><span class="line">    virtual_router_id 51</span><br><span class="line">    # 默认启动优先级，要比Backup 大点，但要控制量，保证自身状态检测生效</span><br><span class="line">    priority 100</span><br><span class="line">    advert_int 1</span><br><span class="line">    authentication &#123;</span><br><span class="line">        auth_type PASS</span><br><span class="line">        auth_pass 1111</span><br><span class="line">    &#125;</span><br><span class="line">    virtual_ipaddress &#123;</span><br><span class="line">        # 虚拟ip 地址</span><br><span class="line">        192.168.0.10</span><br><span class="line">    &#125;</span><br><span class="line">    track_script &#123;</span><br><span class="line">        check_k8s-api</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">virtual_server 192.168.0.10 8080 &#123;</span><br><span class="line">  delay_loop 5</span><br><span class="line">  lvs_sched wlc</span><br><span class="line">  lvs_method NAT</span><br><span class="line">  persistence_timeout 1800</span><br><span class="line">  protocol TCP</span><br><span class="line"></span><br><span class="line">  real_server 192.168.0.11 8080 &#123;</span><br><span class="line">    weight 1</span><br><span class="line">    TCP_CHECK &#123;</span><br><span class="line">      connect_port 8080</span><br><span class="line">      connect_timeout 3</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">virtual_server 192.168.0.10 6443 &#123;</span><br><span class="line">  delay_loop 5</span><br><span class="line">  lvs_sched wlc</span><br><span class="line">  lvs_method NAT</span><br><span class="line">  persistence_timeout 1800</span><br><span class="line">  protocol TCP</span><br><span class="line"></span><br><span class="line">  real_server 192.168.0.11 6443 &#123;</span><br><span class="line">    weight 1</span><br><span class="line">    TCP_CHECK &#123;</span><br><span class="line">      connect_port 6443</span><br><span class="line">      connect_timeout 3</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>统一的方式在master2 节点上安装keepalived，修改配置，只需要将state 更改成BACKUP，priority更改成99，unicast_src_ip 与unicast_peer 地址修改即可。</p><h3 id="启动并验证keepalived"><a href="#启动并验证keepalived" class="headerlink" title="启动并验证keepalived"></a>启动并验证keepalived</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-master1 ~]# systemctl start keepalived</span><br><span class="line">[root@k8s-master1 ~]# systemctl enable keepalived</span><br><span class="line">[root@k8s-master1 ~]# ip addr</span><br><span class="line">3: eno33554960: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc pfifo_fast state UP qlen 1000</span><br><span class="line">    link/ether 00:0c:29:9d:01:ba brd ff:ff:ff:ff:ff:ff</span><br><span class="line">    inet 192.168.0.11/24 brd 192.168.0.255 scope global eno33554960</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">    inet 192.168.0.10/32 scope global eno33554960</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">    inet6 fe80::20c:29ff:fe9d:1ba/64 scope link </span><br><span class="line">       valid_lft forever preferred_lft forever</span><br></pre></td></tr></table></figure><p>本地访问vip+端口进行访问测试<br></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-master1 ~]# curl -I 192.168.0.10:80</span><br><span class="line">HTTP/1.1 200 OK</span><br><span class="line">Content-Type: application/json</span><br><span class="line">Date: Mon, 10 Dec 2018 17:21:49 GMT</span><br><span class="line"></span><br><span class="line">[root@k8s-master1 ~]# curl -I 192.168.0.10:443</span><br><span class="line"></span><br></pre></td></tr></table></figure><p></p><h3 id="注意事项"><a href="#注意事项" class="headerlink" title="注意事项"></a>注意事项</h3><p>将kube-apiserver配置成高可用后，需要将<code>kube-controller-manager</code>和<code>kube-scheduler</code>配置文件中<code>--master</code>选项对应的地址改成vip的地址，然后重启这两个服务。</p><hr><h2 id="部署Node节点"><a href="#部署Node节点" class="headerlink" title="部署Node节点"></a>部署Node节点</h2><h3 id="绑定集群角色"><a href="#绑定集群角色" class="headerlink" title="绑定集群角色"></a>绑定集群角色</h3><p>将kubelet-bootstrap用户绑定到系统集群角色<br></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-master1 ~]# kubectl create clusterrolebinding kubelet-bootstrap --clusterrole=system:node-bootstrapper --user=kubelet-bootstrap </span><br><span class="line">clusterrolebinding.rbac.authorization.k8s.io/kubelet-bootstrap created</span><br></pre></td></tr></table></figure><p></p><h3 id="创建kubeconfig文件"><a href="#创建kubeconfig文件" class="headerlink" title="创建kubeconfig文件"></a>创建kubeconfig文件</h3><p>在生成kubernetes证书的目录下执行以下命令生成kubeconfig文件：<br></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">## 创建kubelet bootstrapping kubeconfig </span><br><span class="line">[root@k8s-master1 ~]# cd /home/kubernetes/ssl</span><br><span class="line"># 指定apiserver 内网负载均衡地址</span><br><span class="line">[root@k8s-master1 ~]# export KUBE_APISERVER=&quot;https://192.168.0.10:6443&quot;</span><br><span class="line">[root@k8s-master1 ~]# export BOOTSTRAP_TOKEN=29cd86c2fd73035417e38c53bc8f12d9</span><br><span class="line"></span><br><span class="line"># 设置集群参数</span><br><span class="line">[root@k8s-master1 ~]# kubectl config set-cluster kubernetes \</span><br><span class="line">--certificate-authority=./ca.pem \</span><br><span class="line">--embed-certs=true \</span><br><span class="line">--server=$&#123;KUBE_APISERVER&#125; \</span><br><span class="line">--kubeconfig=bootstrap.kubeconfig</span><br><span class="line"></span><br><span class="line"># 设置客户端认证参数</span><br><span class="line">[root@k8s-master1 ~]# kubectl config set-credentials kubelet-bootstrap \</span><br><span class="line">--token=$&#123;BOOTSTRAP_TOKEN&#125; \</span><br><span class="line">--kubeconfig=bootstrap.kubeconfig</span><br><span class="line"></span><br><span class="line"># 设置上下文参数</span><br><span class="line">[root@k8s-master1 ~]# kubectl config set-context default \</span><br><span class="line">--cluster=kubernetes \</span><br><span class="line">--user=kubelet-bootstrap \</span><br><span class="line">--kubeconfig=bootstrap.kubeconfig</span><br><span class="line"></span><br><span class="line"># 设置默认上下文</span><br><span class="line">[root@k8s-master1 ~]# kubectl config use-context default --kubeconfig=bootstrap.kubeconfig</span><br></pre></td></tr></table></figure><p></p><p>创建kube-proxy kubeconfig文件<br></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-master1 ~]# kubectl config set-cluster kubernetes \</span><br><span class="line">--certificate-authority=./ca.pem \</span><br><span class="line">--embed-certs=true \</span><br><span class="line">--server=$&#123;KUBE_APISERVER&#125; \</span><br><span class="line">--kubeconfig=kube-proxy.kubeconfig</span><br><span class="line"></span><br><span class="line">[root@k8s-master1 ~]# kubectl config set-credentials kube-proxy \</span><br><span class="line">--client-certificate=./kube-proxy.pem \</span><br><span class="line">--client-key=./kube-proxy-key.pem \</span><br><span class="line">--embed-certs=true \</span><br><span class="line">--kubeconfig=kube-proxy.kubeconfig</span><br><span class="line"></span><br><span class="line">[root@k8s-master1 ~]# kubectl config set-context default \</span><br><span class="line">--cluster=kubernetes \</span><br><span class="line">--user=kube-proxy \</span><br><span class="line">--kubeconfig=kube-proxy.kubeconfig</span><br><span class="line"></span><br><span class="line">[root@k8s-master1 ~]# kubectl config use-context default --kubeconfig=kube-proxy.kubeconfig</span><br><span class="line"></span><br><span class="line">[root@k8s-master1 ~]# ls *.kubeconfig</span><br><span class="line">bootstrap.kubeconfig  kube-proxy.kubeconfig</span><br></pre></td></tr></table></figure><p></p><p>将这两个配置文件拷贝到node节点的/home/kubernetes/conf/目录下<br></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-master1 ~]# scp *.kubeconfig k8s-node1:/home/kubernetes/conf/</span><br><span class="line">[root@k8s-master1 ~]# scp *.kubeconfig k8s-node2:/home/kubernetes/conf/</span><br></pre></td></tr></table></figure><p></p><h3 id="部署kubelet组件"><a href="#部署kubelet组件" class="headerlink" title="部署kubelet组件"></a>部署kubelet组件</h3><p>将前面下载二进制包中的kubelet和kube-proxy拷贝到Node节点的/home/kubernetes/bin目录下<br></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-master1 ~]# cd kubernetes/server/bin/</span><br><span class="line">[root@k8s-master1 bin]# scp kubelet kube-proxy k8s-node1:/home/kubernetes/bin/</span><br><span class="line">[root@k8s-master1 bin]# scp kubelet kube-proxy k8s-node2:/home/kubernetes/bin/</span><br></pre></td></tr></table></figure><p></p><p>创建kubelet配置文件<br></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-node1 ~]# vim /home/kubernetes/conf/kubelet</span><br><span class="line">KUBELET_OPTS=&quot;--logtostderr=true \</span><br><span class="line">--v=4 \</span><br><span class="line">--hostname-override=192.168.0.13 \</span><br><span class="line">--kubeconfig=/home/kubernetes/conf/kubelet.kubeconfig \</span><br><span class="line">--bootstrap-kubeconfig=/home/kubernetes/conf/bootstrap.kubeconfig \</span><br><span class="line">--config=/home/kubernetes/conf/kubelet.config \</span><br><span class="line">--cert-dir=/home/kubernetes/ssl \</span><br><span class="line">--pod-infra-container-image=registry.cn-hangzhou.aliyuncs.com/google-containers/pause-amd64:3.0&quot;</span><br></pre></td></tr></table></figure><p></p><p>参数说明：</p><ul><li><code>--hostname-override</code> 在集群中显示的主机名</li><li><code>--kubeconfig</code> 指定kubeconfig文件位置，会自动生成</li><li><code>--bootstrap-kubeconfig</code> 指定刚才生成的bootstrap.kubeconfig文件</li><li><code>--cert-dir</code> 颁发证书存放位置</li><li><code>--cluster-dns</code> 集群DNS IP，先配置上，后面会讲到</li><li><code>--cluster-domain</code> DNS域</li><li><code>--fail-swap-on=false</code> 禁止使用swap</li><li><code>--pod-infra-container-image</code> 管理Pod网络的镜像<br>编写kubelet.config配置文件:<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-node1 ~]# vim /home/kubernetes/conf/kubelet.config</span><br><span class="line">kind: KubeletConfiguration</span><br><span class="line">apiVersion: kubelet.config.k8s.io/v1beta1</span><br><span class="line">address: 192.168.0.13</span><br><span class="line">port: 10250</span><br><span class="line">readOnlyPort: 10255</span><br><span class="line">cgroupDriver: cgroupfs</span><br><span class="line">clusterDNS: [&quot;192.168.0.2&quot;]</span><br><span class="line">clusterDomain: cluster.local.</span><br><span class="line">failSwapOn: false</span><br><span class="line">authentication:</span><br><span class="line">  anonymous:</span><br><span class="line">    enabled: true</span><br><span class="line">  webhook:</span><br><span class="line">    enabled: false</span><br></pre></td></tr></table></figure></li></ul><p>使用systemctl管理kubelet组件：<br></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-node1 ~]# vim /usr/lib/systemd/system/kubelet.service</span><br><span class="line">[Unit]</span><br><span class="line">Description=Kubernetes Kubelet</span><br><span class="line">After=docker.service</span><br><span class="line">Requires=docker.service</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">EnvironmentFile=/home/kubernetes/conf/kubelet</span><br><span class="line">ExecStart=/home/kubernetes/bin/kubelet $KUBELET_OPTS</span><br><span class="line">Restart=on-failure</span><br><span class="line">KillMode=process</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br></pre></td></tr></table></figure><p></p><p>启动kubelet:<br></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">systemctl start kubelet</span><br><span class="line">systemctl enable kubelet</span><br></pre></td></tr></table></figure><p></p><h3 id="在master审批Node加入集群"><a href="#在master审批Node加入集群" class="headerlink" title="在master审批Node加入集群"></a>在master审批Node加入集群</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"># 查看请求签名的node</span><br><span class="line">[root@k8s-master1 ssl]# kubectl get csr</span><br><span class="line">NAME                                                   AGE       REQUESTOR           CONDITION</span><br><span class="line">node-csr-WshP4cKZMpaIT8mE67wfk2PE1LKl2tz_6-KbMcCNL5M   2d        kubelet-bootstrap   Pending</span><br><span class="line">node-csr-zvLNjTqRalExD0Mhr0SYiZ83uSZ0uSm0kNvoaix56hc   2d        kubelet-bootstrap   Pending</span><br><span class="line"></span><br><span class="line"># 通过CSR 请求</span><br><span class="line">[root@k8s-master1 ~]# kubectl certificate approve node-csr-WshP4cKZMpaIT8mE67wfk2PE1LKl2tz_6-KbMcCNL5M</span><br><span class="line">certificatesigningrequest.certificates.k8s.io/node-csr-WshP4cKZMpaIT8mE67wfk2PE1LKl2tz_6-KbMcCNL5M approved</span><br><span class="line">[root@k8s-master1 ~]# kubectl certificate approve node-csr-zvLNjTqRalExD0Mhr0SYiZ83uSZ0uSm0kNvoaix56hc</span><br><span class="line">certificatesigningrequest.certificates.k8s.io/node-csr-zvLNjTqRalExD0Mhr0SYiZ83uSZ0uSm0kNvoaix56hc approved</span><br><span class="line"></span><br><span class="line"># 查看请求签名的node状态</span><br><span class="line">[root@k8s-master1 ~]# kubectl get csr</span><br><span class="line">NAME                                                   AGE       REQUESTOR           CONDITION</span><br><span class="line">node-csr-WshP4cKZMpaIT8mE67wfk2PE1LKl2tz_6-KbMcCNL5M   2d        kubelet-bootstrap   Approved,Issued</span><br><span class="line">node-csr-zvLNjTqRalExD0Mhr0SYiZ83uSZ0uSm0kNvoaix56hc   2d        kubelet-bootstrap   Approved,Issued</span><br><span class="line"></span><br><span class="line"># 查看node连接状态</span><br><span class="line">[root@k8s-master1 ~]# kubectl get node</span><br><span class="line">NAME           STATUS    ROLES     AGE       VERSION</span><br><span class="line">192.168.0.13   Ready     &lt;none&gt;    42m       v1.11.5</span><br><span class="line">192.168.0.14   Ready     &lt;none&gt;    28s       v1.11.5</span><br></pre></td></tr></table></figure><h3 id="部署kube-proxy组件"><a href="#部署kube-proxy组件" class="headerlink" title="部署kube-proxy组件"></a>部署kube-proxy组件</h3><p>创建kube-proxy配置文件<br></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-node1 ~]# vim /home/kubernetes/conf/kube-proxy</span><br><span class="line">KUBE_PROXY_OPTS=&quot;--logtostderr=true \</span><br><span class="line">--v=4 \</span><br><span class="line">--hostname-override=192.168.0.13 \</span><br><span class="line">--cluster-cidr=192.168.0.0/24 \</span><br><span class="line">--kubeconfig=/home/kubernetes/conf/kube-proxy.kubeconfig&quot;</span><br></pre></td></tr></table></figure><p></p><p>systemctl管理kube-proxy组件<br></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-node1 ~]# vim /usr/lib/systemd/system/kube-proxy.service</span><br><span class="line">[Unit]</span><br><span class="line">Description=Kubernetes Proxy</span><br><span class="line">After=network.target</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">EnvironmentFile=-/home/kubernetes/conf/kube-proxy</span><br><span class="line">ExecStart=/home/kubernetes/bin/kube-proxy $KUBE_PROXY_OPTS</span><br><span class="line">Restart=on-failure</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br></pre></td></tr></table></figure><p></p><p>启动kube-proxy<br></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-node1 ~]# systemctl enable kube-proxy</span><br><span class="line">[root@k8s-node1 ~]# systemctl start kube-proxy</span><br><span class="line">[root@k8s-node1 ~]# systemctl status kube-proxy</span><br></pre></td></tr></table></figure><p></p><p>6.6 安装完所有服务后，检查一下集群状态<br></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-master1 ~]# kubectl get cs</span><br><span class="line">NAME                 STATUS    MESSAGE              ERROR</span><br><span class="line">scheduler            Healthy   ok                   </span><br><span class="line">controller-manager   Healthy   ok                   </span><br><span class="line">etcd-0               Healthy   &#123;&quot;health&quot;: &quot;true&quot;&#125;   </span><br><span class="line">etcd-2               Healthy   &#123;&quot;health&quot;: &quot;true&quot;&#125;   </span><br><span class="line">etcd-3               Healthy   &#123;&quot;health&quot;: &quot;true&quot;&#125;   </span><br><span class="line">etcd-1               Healthy   &#123;&quot;health&quot;: &quot;true&quot;&#125;   </span><br><span class="line">[root@k8s-master1 ~]# kubectl get csr</span><br><span class="line">NAME                                                   AGE       REQUESTOR           CONDITION</span><br><span class="line">node-csr-WshP4cKZMpaIT8mE67wfk2PE1LKl2tz_6-KbMcCNL5M   2d        kubelet-bootstrap   Approved,Issued</span><br><span class="line">node-csr-zvLNjTqRalExD0Mhr0SYiZ83uSZ0uSm0kNvoaix56hc   2d        kubelet-bootstrap   Approved,Issued</span><br><span class="line">[root@k8s-master1 ~]# kubectl get node</span><br><span class="line">NAME           STATUS    ROLES     AGE       VERSION</span><br><span class="line">192.168.0.13   Ready     &lt;none&gt;    1h        v1.11.5</span><br><span class="line">192.168.0.14   Ready     &lt;none&gt;    24m       v1.11.5</span><br></pre></td></tr></table></figure><p></p><h2 id="运行一个测试示例"><a href="#运行一个测试示例" class="headerlink" title="运行一个测试示例"></a>运行一个测试示例</h2><p>创建一个nginx，判断集群是否正常工作<br></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-master1 ~]# kubectl run nginx --image=nginx --replicas=3</span><br><span class="line">deployment.apps/nginx created</span><br><span class="line">[root@k8s-master1 ~]# kubectl expose deployment nginx --port=88 --target-port=80 --type=NodePort</span><br><span class="line">service/nginx exposed</span><br></pre></td></tr></table></figure><p></p><p>查看已创建的pod<br></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-master1 ~]# kubectl get pods</span><br><span class="line">NAME                     READY     STATUS              RESTARTS   AGE</span><br><span class="line">nginx-64f497f8fd-6gg5n   0/1       ContainerCreating   0          23s</span><br><span class="line">nginx-64f497f8fd-qj8p9   0/1       ContainerCreating   0          23s</span><br><span class="line">nginx-64f497f8fd-xxmtm   0/1       ContainerCreating   0          23s</span><br><span class="line">[root@k8s-master1 ~]# kubectl get svc</span><br><span class="line">NAME         TYPE        CLUSTER-IP      EXTERNAL-IP   PORT(S)        AGE</span><br><span class="line">kubernetes   ClusterIP   192.168.0.1     &lt;none&gt;        443/TCP        2d</span><br><span class="line">nginx        NodePort    192.168.0.119   &lt;none&gt;        88:48065/TCP   25s</span><br></pre></td></tr></table></figure><p></p><p>访问node节点的ip的48065端口(<a href="http://192.168.0.13:48065" target="_blank" rel="noopener">http://192.168.0.13:48065</a>)<br><img src="leanote://file/getImage?fileId=5c1209c6ab6441071500229f" alt=""><br>看到如上页面表示集群搭建成功</p><hr><h2 id="安装kubernetes-dashboard"><a href="#安装kubernetes-dashboard" class="headerlink" title="安装kubernetes-dashboard"></a>安装kubernetes-dashboard</h2><p>创建<code>kubernetes-dashboard</code>yaml文件<br></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-master1 ~]# mkdir /home/dashboard</span><br><span class="line">[root@k8s-master1 ~]# cd /home/dashboard/</span><br><span class="line">[root@k8s-master1 dashboard]# vim dashboard-deployment.yaml </span><br><span class="line">apiVersion: apps/v1beta2</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">  name: kubernetes-dashboard</span><br><span class="line">  namespace: kube-system</span><br><span class="line">  labels:</span><br><span class="line">    k8s-app: kubernetes-dashboard</span><br><span class="line">    kubernetes.io/cluster-service: &quot;true&quot;</span><br><span class="line">    addonmanager.kubernetes.io/mode: Reconcile</span><br><span class="line">spec:</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      k8s-app: kubernetes-dashboard</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        k8s-app: kubernetes-dashboard</span><br><span class="line">      annotations:</span><br><span class="line">        scheduler.alpha.kubernetes.io/critical-pod: &apos;&apos;</span><br><span class="line">    spec:</span><br><span class="line">      serviceAccountName: kubernetes-dashboard</span><br><span class="line">      containers:</span><br><span class="line">      - name: kubernetes-dashboard</span><br><span class="line">        image: registry.cn-hangzhou.aliyuncs.com/kube_containers/kubernetes-dashboard-amd64:v1.8.1</span><br><span class="line">        resources:</span><br><span class="line">          limits:</span><br><span class="line">            cpu: 100m</span><br><span class="line">            memory: 300Mi</span><br><span class="line">          requests:</span><br><span class="line">            cpu: 100m</span><br><span class="line">            memory: 100Mi</span><br><span class="line">        ports:</span><br><span class="line">        - containerPort: 9090</span><br><span class="line">          protocol: TCP</span><br><span class="line">        livenessProbe:</span><br><span class="line">          httpGet:</span><br><span class="line">            scheme: HTTP</span><br><span class="line">            path: /</span><br><span class="line">            port: 9090</span><br><span class="line">          initialDelaySeconds: 30</span><br><span class="line">          timeoutSeconds: 30</span><br><span class="line">      tolerations:</span><br><span class="line">      - key: &quot;CriticalAddonsOnly&quot;</span><br><span class="line">        operator: &quot;Exists&quot;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[root@k8s-master1 dashboard]# vim dashboard-rbac.yaml </span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: ServiceAccount</span><br><span class="line">metadata:</span><br><span class="line">  labels:</span><br><span class="line">    k8s-app: kubernetes-dashboard</span><br><span class="line">    addonmanager.kubernetes.io/mode: Reconcile</span><br><span class="line">  name: kubernetes-dashboard</span><br><span class="line">  namespace: kube-system</span><br><span class="line">---</span><br><span class="line"></span><br><span class="line">kind: ClusterRoleBinding</span><br><span class="line">apiVersion: rbac.authorization.k8s.io/v1beta1</span><br><span class="line">metadata:</span><br><span class="line">  name: kubernetes-dashboard-minimal</span><br><span class="line">  namespace: kube-system</span><br><span class="line">  labels:</span><br><span class="line">    k8s-app: kubernetes-dashboard</span><br><span class="line">    addonmanager.kubernetes.io/mode: Reconcile</span><br><span class="line">roleRef:</span><br><span class="line">  apiGroup: rbac.authorization.k8s.io</span><br><span class="line">  kind: ClusterRole</span><br><span class="line">  name: cluster-admin</span><br><span class="line">subjects:</span><br><span class="line">  - kind: ServiceAccount</span><br><span class="line">    name: kubernetes-dashboard</span><br><span class="line">    namespace: kube-system</span><br><span class="line"></span><br><span class="line">[root@k8s-master1 dashboard]# vim dashboard-service.yaml </span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Service</span><br><span class="line">metadata:</span><br><span class="line">  name: kubernetes-dashboard</span><br><span class="line">  namespace: kube-system</span><br><span class="line">  labels:</span><br><span class="line">    k8s-app: kubernetes-dashboard</span><br><span class="line">    kubernetes.io/cluster-service: &quot;true&quot;</span><br><span class="line">    addonmanager.kubernetes.io/mode: Reconcile</span><br><span class="line">spec:</span><br><span class="line">  type: NodePort</span><br><span class="line">  selector:</span><br><span class="line">    k8s-app: kubernetes-dashboard</span><br><span class="line">  ports:</span><br><span class="line">  - port: 80</span><br><span class="line">    targetPort: 9090</span><br></pre></td></tr></table></figure><p></p><p>运行kubernetes-dashboard<br></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-master1 dashboard]# kubectl create -f .</span><br></pre></td></tr></table></figure><p></p><p>查看访问端口:<br></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-master1 ~]# kubectl get svc -n kube-system</span><br><span class="line">NAME                   TYPE       CLUSTER-IP     EXTERNAL-IP   PORT(S)        AGE</span><br><span class="line">kubernetes-dashboard   NodePort   192.168.0.15   &lt;none&gt;        80:30287/TCP   5m</span><br></pre></td></tr></table></figure><p></p><p>排错方法：<br></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"># 查看pod状态</span><br><span class="line">[root@k8s-master1 ~]# kubectl get pods -n kube-system                                 </span><br><span class="line">NAME                                   READY     STATUS             RESTARTS   AGE</span><br><span class="line">kubernetes-dashboard-d9545b947-dk2qg   0/1       CrashLoopBackOff   3          1m</span><br><span class="line"># 查看pod详细信息</span><br><span class="line">[root@k8s-master1 ~]# kubectl describe pod kubernetes-dashboard -n kube-system</span><br><span class="line"># 查看pod日志信息</span><br><span class="line">[root@k8s-master1 ~]# kubectl logs kubernetes-dashboard-d9545b947-dk2qg -n kube-system</span><br></pre></td></tr></table></figure><p></p></div><div class="article-footer"><blockquote class="mt-2x"><ul class="post-copyright list-unstyled"><li class="post-copyright-link hidden-xs"><strong>本文链接：</strong> <a href="http://blog.wubolive.com/2018/12/18/k8s-install/" title="高可用源码部署Kubernetes" target="_blank" rel="external">http://blog.wubolive.com/2018/12/18/k8s-install/</a></li><li class="post-copyright-license"><strong>版权声明： </strong>本博客所有文章除特别声明外，均采用 <a href="http://creativecommons.org/licenses/by/4.0/deed.zh" target="_blank" rel="external">CC BY 4.0 CN协议</a> 许可协议。转载请注明出处！</li></ul></blockquote><div class="panel panel-default panel-badger"><div class="panel-body"><figure class="media"><div class="media-left"><a href="https://github.com/wubolive" target="_blank" class="img-burn thumb-sm visible-lg"><img src="/images/avatar.jpg" class="img-rounded w-full" alt=""></a></div><div class="media-body"><h3 class="media-heading"><a href="https://github.com/wubolive" target="_blank"><span class="text-dark">Wave</span><small class="ml-1x">Linux operation</small></a></h3><div>来自南方的Linux运维小哥</div></div></figure></div></div></div></article><section id="comments"></section></div><nav class="bar bar-footer clearfix" data-stick-bottom=""><div class="bar-inner"><ul class="pager pull-left"><li class="prev"><a href="/2018/12/18/k8s-pod-error/" title="Kubernetes 排错之 Pod 异常"><i class="icon icon-angle-left" aria-hidden="true"></i><span>&nbsp;&nbsp;上一篇</span></a></li><li class="next"><a href="/2018/12/07/nfs-install/" title="CentOS6 安装nfs共享目录服务"><span>下一篇&nbsp;&nbsp;</span><i class="icon icon-angle-right" aria-hidden="true"></i></a></li><li class="toggle-toc"><a class="toggle-btn collapsed" data-toggle="collapse" href="#collapseToc" aria-expanded="false" title="文章目录" role="button"><span>[&nbsp;</span><span>文章目录</span> <i class="text-collapsed icon icon-anchor"></i> <i class="text-in icon icon-close"></i> <span>]</span></a></li></ul><button type="button" class="btn btn-fancy btn-donate pop-onhover bg-gradient-warning" data-toggle="modal" data-target="#donateModal"><span>赏</span></button><div class="bar-right"><div class="share-component" data-sites="weibo,qq,wechat,facebook,twitter" data-mobile-sites="weibo,qq,qzone"></div></div></div></nav><div class="modal modal-center modal-small modal-xs-full fade" id="donateModal" tabindex="-1" role="dialog"><div class="modal-dialog" role="document"><div class="modal-content donate"><button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button><div class="modal-body"><div class="donate-box"><div class="donate-head"><p>感谢您的支持，我会继续努力的!</p></div><div class="tab-content"><div role="tabpanel" class="tab-pane fade active in" id="alipay"><div class="donate-payimg"><img src="/images/donate/alipayimg.png" alt="扫码支持" title="扫一扫"></div><p class="text-muted mv">扫码打赏，你说多少就多少</p><p class="text-grey">打开支付宝扫一扫，即可进行扫码打赏哦</p></div><div role="tabpanel" class="tab-pane fade" id="wechatpay"><div class="donate-payimg"><img src="/images/donate/wechatpayimg.png" alt="扫码支持" title="扫一扫"></div><p class="text-muted mv">扫码打赏，你说多少就多少</p><p class="text-grey">打开微信扫一扫，即可进行扫码打赏哦</p></div></div><div class="donate-footer"><ul class="nav nav-tabs nav-justified" role="tablist"><li role="presentation" class="active"><a href="#alipay" id="alipay-tab" role="tab" data-toggle="tab" aria-controls="alipay" aria-expanded="true"><i class="icon icon-alipay"></i> 支付宝</a></li><li role="presentation"><a href="#wechatpay" role="tab" id="wechatpay-tab" data-toggle="tab" aria-controls="wechatpay" aria-expanded="false"><i class="icon icon-wepay"></i> 微信支付</a></li></ul></div></div></div></div></div></div></main><footer class="footer" itemscope itemtype="http://schema.org/WPFooter"><ul class="social-links"><li><a href="https://github.com/wubolive" target="_blank" title="Github" data-toggle="tooltip" data-placement="top"><i class="icon icon-github"></i></a></li><li><a href="http://weibo.com/cofess" target="_blank" title="Weibo" data-toggle="tooltip" data-placement="top"><i class="icon icon-weibo"></i></a></li><li><a href="https://twitter.com/iwebued" target="_blank" title="Twitter" data-toggle="tooltip" data-placement="top"><i class="icon icon-twitter"></i></a></li><li><a href="https://www.behance.net/cofess" target="_blank" title="Behance" data-toggle="tooltip" data-placement="top"><i class="icon icon-behance"></i></a></li><li><a href="/atom.xml" target="_blank" title="Rss" data-toggle="tooltip" data-placement="top"><i class="icon icon-rss"></i></a></li></ul><div class="copyright">&copy; 2018 John Doe<div class="publishby">Theme by <a href="https://github.com/cofess" target="_blank">cofess </a>base on <a href="https://github.com/cofess/hexo-theme-pure" target="_blank">pure</a>.</div></div></footer><script src="//cdn.jsdelivr.net/npm/jquery@1.12.4/dist/jquery.min.js"></script><script>window.jQuery||document.write('<script src="js/jquery.min.js"><\/script>')</script><script src="/js/plugin.min.js"></script><script src="/js/application.js"></script><script>!function(T){var N={TRANSLATION:{POSTS:"文章",PAGES:"页面",CATEGORIES:"分类",TAGS:"标签",UNTITLED:"(未命名)"},ROOT_URL:"/",CONTENT_URL:"/content.json"};T.INSIGHT_CONFIG=N}(window)</script><script src="/js/insight.js"></script><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><script src="//cdn.jsdelivr.net/npm/gitalk@1.4.0/dist/gitalk.min.js"></script><script src="//cdn.jsdelivr.net/npm/blueimp-md5@2.10.0/js/md5.min.js"></script><script type="text/javascript">var gitalk=new Gitalk({clientID:"66aca292843079a69ab9",clientSecret:"3e21c396b030f09b747aab6610530199f7fdd956",repo:"wubolive.github.io",owner:"wubolive",admin:["wubolive"],id:md5(location.pathname),distractionFreeMode:!0});gitalk.render("comments")</script></body></html><!-- rebuild by neat -->